<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=author content="KK"><meta name=description content="Python supports multiple inheritance, its class can be derived from more than one base classes. If the specified attribute or methods was not found in current class, how to decide the search sequence from superclasses? In simple scenario, we know left-to right, bottom to up. But when the inheritance hierarchy become complicated, it&rsquo;s not easy to answer by intuition.
For instance, what&rsquo;s search sequence of class M?
class X:pass class Y: pass class Z:pass class A(X,Y):pass class B(Y,Z):pass class M(B,A,Z):pass   The answer is: M, B, A, X, Y, Z, object"><meta name=keywords content="fromkk,blog,kk blog,developer,personal,python,golang,go,linux,machine learning"><meta name=twitter:card content="summary"><meta name=twitter:title content="C3 Linearization and Python MRO(Method Resolution Order)"><meta name=twitter:description content="Python supports multiple inheritance, its class can be derived from more than one base classes. If the specified attribute or methods was not found in current class, how to decide the search sequence from superclasses? In simple scenario, we know left-to right, bottom to up. But when the inheritance hierarchy become complicated, it&rsquo;s not easy to answer by intuition.
For instance, what&rsquo;s search sequence of class M?
class X:pass class Y: pass class Z:pass class A(X,Y):pass class B(Y,Z):pass class M(B,A,Z):pass   The answer is: M, B, A, X, Y, Z, object"><meta property="og:title" content="C3 Linearization and Python MRO(Method Resolution Order)"><meta property="og:description" content="Python supports multiple inheritance, its class can be derived from more than one base classes. If the specified attribute or methods was not found in current class, how to decide the search sequence from superclasses? In simple scenario, we know left-to right, bottom to up. But when the inheritance hierarchy become complicated, it&rsquo;s not easy to answer by intuition.
For instance, what&rsquo;s search sequence of class M?
class X:pass class Y: pass class Z:pass class A(X,Y):pass class B(Y,Z):pass class M(B,A,Z):pass   The answer is: M, B, A, X, Y, Z, object"><meta property="og:type" content="article"><meta property="og:url" content="https://www.fromkk.com/posts/c3-linearization-and-python-mro-method-resolution-order/"><meta property="article:published_time" content="2020-03-14T17:37:00+08:00"><meta property="article:modified_time" content="2020-03-26T00:31:24+08:00"><base href=https://www.fromkk.com/posts/c3-linearization-and-python-mro-method-resolution-order/><title>C3 Linearization and Python MRO(Method Resolution Order) · KK's Blog (fromkk)</title><link rel=canonical href=https://www.fromkk.com/posts/c3-linearization-and-python-mro-method-resolution-order/><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.13.0/css/all.css integrity=sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://www.fromkk.com/css/coder.min.a4f332213a21ce8eb521670c614470c58923aaaf385e2a73982c31dd7642decb.css integrity="sha256-pPMyITohzo61IWcMYURwxYkjqq84XipzmCwx3XZC3ss=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://www.fromkk.com/css/custom.css><link rel=icon type=image/png href=https://www.fromkk.com/icons/icon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://www.fromkk.com/icons/icon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.68.3"></head><body class=colorscheme-light><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://www.fromkk.com/>KK's Blog (fromkk)</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fas fa-bars"></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/posts/index.xml>RSS</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>C3 Linearization and Python MRO(Method Resolution Order)</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i><time datetime=2020-03-14T17:37:00+08:00>03/14/2020</time></span>
<span class=reading-time><i class="fas fa-clock"></i>3-minute read</span></div><div class=tags><i class="fas fa-tag"></i><a href=https://www.fromkk.com/tags/python/>Python</a>
<span class=separator>•</span>
<a href=https://www.fromkk.com/tags/mro/>MRO</a></div></div></header><div><p>Python supports multiple inheritance, its class can be derived from more than one base classes. If the specified attribute or methods was not found in current class, how to decide the search sequence from superclasses? In simple scenario, we know left-to right, bottom to up. But when the inheritance hierarchy become complicated, it&rsquo;s not easy to answer by intuition.</p><p>For instance, what&rsquo;s search sequence of class M?</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>X</span>:<span style=color:#66d9ef>pass</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Y</span>: <span style=color:#66d9ef>pass</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Z</span>:<span style=color:#66d9ef>pass</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>A</span>(X,Y):<span style=color:#66d9ef>pass</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>B</span>(Y,Z):<span style=color:#66d9ef>pass</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>M</span>(B,A,Z):<span style=color:#66d9ef>pass</span>
</code></pre></div><figure><img src=https://www.fromkk.com/images/python_mro.png width=400></figure><p>The answer is: <code>M, B, A, X, Y, Z, object</code></p><h2 id=c3-algorithm>C3 Algorithm</h2><p>How did Python generate this sequence? After Python 2.3, it use <code>C3 Linearization</code> algorithm.</p><p>C3 follows these two equation:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>L[object] = [object]
L[C(B1…BN)] = [C] + merge(L[B1]…L[BN], [B1, … ,BN])
</code></pre></div><p><code>L[C]</code> is the MRO of class C, it will evaluate to a list.</p><p>The key process is <strong>merge</strong>, it get a list and generate a list by this way:</p><ol><li>First, check the first list&rsquo;s head element(<code>L[B1]</code>) as H.</li><li>If H is not in the tail of other list, output it, and remove it from all of the list, then go to step 1. Otherwise, check the next list&rsquo;s head as H, go to step 2. (tail means the rest of the list except the first element)</li><li>If <strong>merge</strong>&lsquo;s list is empty, end algorithm. If list is not empty but not able to find element to output, raise error.</li></ol><p>That seems complicated, I&rsquo;ll use the previous example again to explain the calculation of C3.</p><p>Let&rsquo;s begin with the easy ones. Firstly, calculate <code>A</code>'s MRO:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>L[A(X,Y)]=[A]+merge(L[X],L[Y],[X,Y])
         =[A]+merge([X,obj],[Y,obj],[X,Y])
         # X is not tail of other list, use it as H
         =[A,X]+merge([obj],[Y,obj],[Y])
         # obj is in the tail of[Y.obj], use Y as H
         =[A,X,Y]+merge([obj],[obj]]
         =[A,X,Y,obj]
</code></pre></div><p><code>B</code>'s MRO <code>[B,Y,Z,obj]</code> and <code>Z</code>'s MRO <code>[z,obj]</code> can also be calculated.</p><p>Now we can get <code>M</code>'s MRO:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>L[M(B,A,Z)]=[M]+merge(L[B],L[A],L[Z],[B,A,Z])
         =[M]+merge([B,Y,Z,obj],[A,X,Y,obj],[Z,obj],[B,A,Z])
         =[M,B]+merge([Y,Z,obj],[A,X,Y,obj],[Z,obj],[A,Z])
         # Y is in the tail of [A,X,Y,obj], use A as H
         =[M,B,A]+merge([Y,Z,obj],[X,Y,obj],[Z,obj],[Z])
         # Y is in the tail of [X,Y,obj], use X as H
         =[M,B,A,X]+merge([Y,Z,obj],[Y,obj],[Z,obj],[Z])
         =[M,B,A,X,Y]+merge([Z,obj],[obj],[Z,obj],[Z])
         =[M,B,A,X,Y,X]+merge([obj],[obj],[obj])
         =[M,B,A,X,Y,X,obj]
</code></pre></div><h2 id=mro-and-super>MRO and super()</h2><p><code>super</code> also use C3 to find the inherited method to execute.</p><p>For instance, <code>C</code>'s MRO is <code>C,A,B,C,obj</code>, so after <code>enter B</code>, it will output <code>enter A</code> rather than <code>enter base</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Base</span>:
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self):
        print(<span style=color:#e6db74>&#39;enter base&#39;</span>)
        print(<span style=color:#e6db74>&#39;leave base&#39;</span>)


<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>A</span>(Base):
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self):
        print(<span style=color:#e6db74>&#39;enter A&#39;</span>)
        super(A, self)<span style=color:#f92672>.</span>__init__()
        print(<span style=color:#e6db74>&#39;leave A&#39;</span>)


<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>B</span>(Base):
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self):
        print(<span style=color:#e6db74>&#39;enter B&#39;</span>)
        super(B, self)<span style=color:#f92672>.</span>__init__()
        print(<span style=color:#e6db74>&#39;leave B&#39;</span>)


<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>C</span>(A, B):
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self):
        print(<span style=color:#e6db74>&#39;enter C&#39;</span>)
        super(C, self)<span style=color:#f92672>.</span>__init__()
        print(<span style=color:#e6db74>&#39;leave C&#39;</span>)

c <span style=color:#f92672>=</span> C()
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>enter C
enter A
enter B
enter base
leave base
leave B
leave A
leave C
</code></pre></div><p><code>super</code> works like this, it will get <code>inst</code>'s MRO, find <code>cls</code>'s index, return next class in MRO. (In python3, <code>super(A,self)</code> can be write as <code>super()</code>)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>super</span>(cls, inst):
    mro <span style=color:#f92672>=</span> inst<span style=color:#f92672>.</span>__class__<span style=color:#f92672>.</span>mro()
    <span style=color:#66d9ef>return</span> mro[mro<span style=color:#f92672>.</span>index(cls) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>]
</code></pre></div><p>When running this line <code>super(C, self).__init__()</code>, self is <code>C</code>'s instance, mro is:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[&lt;class &#39;__main__.C&#39;&gt;, &lt;class &#39;__main__.A&#39;&gt;, &lt;class &#39;__main__.B&#39;&gt;, &lt;class &#39;__main__.Base&#39;&gt;, &lt;class &#39;object&#39;&gt;]
</code></pre></div><p>So it returns <code>A</code>, and A will execute <code>__init__()</code>, then calling <code>super(A, self).__init__()</code>, end enter <code>B</code>'s <code>__init__()</code>. (<code>C</code>'s instance will pass as <code>self</code> in the calling chain.)</p><h2 id=ref>Ref:</h2><ol><li><a href=https://www.python.org/download/releases/2.3/mro/>The Python 2.3 Method Resolution Order</a></li><li><a href=https://www.programiz.com/python-programming/multiple-inheritance>Python Multiple Inheritance</a></li><li><a href=https://www.jianshu.com/p/de7d38c84443>python之理解super及MRO列表</a></li><li><a href=https://www.cnblogs.com/miyauchi-renge/p/10922092.html>Python的MRO以及C3线性化算法</a></li><li><a href=https://en.wikipedia.org/wiki/C3%5Flinearization>C3 linearization</a></li></ol></div><footer><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"kkblog-1"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js id=MathJax-script></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};</script></section></div><footer class=footer><section class=container>©
2020
KK
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-153788833-1','auto');ga('send','pageview');}</script></body></html>