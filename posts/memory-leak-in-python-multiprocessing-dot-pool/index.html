<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=color-scheme content="light dark"><meta name=author content="KK"><meta name=description content="There is a historical memory leak problem in our Django app and I fixed it recently. As time goes by, the memory usage of app keeps growing and so does the CPU usage.
 After some research, I figure out the cause. Some views does not close multiprocessing.Pool after using it. The problem disappears when I use Pool with with statement.
 But I&rsquo;m still interested in it and wrote some testing code."><meta name=keywords content="fromkk,blog,kk blog,developer,personal,python,golang,go,linux,machine learning"><meta name=twitter:card content="summary"><meta name=twitter:title content="Memory Leak in Python multiprocessing.Pool"><meta name=twitter:description content="There is a historical memory leak problem in our Django app and I fixed it recently. As time goes by, the memory usage of app keeps growing and so does the CPU usage.
 After some research, I figure out the cause. Some views does not close multiprocessing.Pool after using it. The problem disappears when I use Pool with with statement.
 But I&rsquo;m still interested in it and wrote some testing code."><meta property="og:title" content="Memory Leak in Python multiprocessing.Pool"><meta property="og:description" content="There is a historical memory leak problem in our Django app and I fixed it recently. As time goes by, the memory usage of app keeps growing and so does the CPU usage.
 After some research, I figure out the cause. Some views does not close multiprocessing.Pool after using it. The problem disappears when I use Pool with with statement.
 But I&rsquo;m still interested in it and wrote some testing code."><meta property="og:type" content="article"><meta property="og:url" content="https://www.fromkk.com/posts/memory-leak-in-python-multiprocessing-dot-pool/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-16T21:04:00+08:00"><meta property="article:modified_time" content="2022-03-16T21:14:37+08:00"><title>Memory Leak in Python multiprocessing.Pool · KK's Blog (fromkk)</title><link rel=canonical href=https://www.fromkk.com/posts/memory-leak-in-python-multiprocessing-dot-pool/><link rel=preload href="https://www.fromkk.com/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://www.fromkk.com/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css integrity="sha256-2f3b/+byfmmYXcX+BHHNsOV/v0d1cUvD2Eesywj0ofY=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://www.fromkk.com/css/coder-dark.min.002ee2378e14c7a68f1f0a53d9694ed252090987c4e768023fac694a4fc5f793.css integrity="sha256-AC7iN44Ux6aPHwpT2WlO0lIJCYfE52gCP6xpSk/F95M=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://www.fromkk.com/icons/icon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://www.fromkk.com/icons/icon-16x16.png sizes=16x16><link rel=apple-touch-icon href=https://www.fromkk.com/icons/icon-192x192.png><link rel=apple-touch-icon sizes=180x180 href=https://www.fromkk.com/icons/icon-192x192.png><meta name=generator content="Hugo 0.94.2"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://www.fromkk.com/>KK's Blog (fromkk)</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/posts/index.xml>RSS</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://www.fromkk.com/posts/memory-leak-in-python-multiprocessing-dot-pool/>Memory Leak in Python multiprocessing.Pool</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2022-03-16T21:04:00+08:00>03/16/2022</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
4-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=https://www.fromkk.com/tags/python/>Python</a></span></div></div></header><div><p>There is a historical memory leak problem in our Django app and I fixed it recently. As time goes by, the memory usage of app keeps growing and so does the CPU usage.</p><figure><img src=https://www.fromkk.com/images/pool_before.png></figure><p>After some research, I figure out the cause. Some views does not close <code>multiprocessing.Pool</code> after using it. The problem disappears when I use <code>Pool</code> with <code>with</code> statement.</p><figure><img src=https://www.fromkk.com/images/pool_after.png></figure><p>But I&rsquo;m still interested in it and wrote some testing code. The script is run in Python 3.6.8 and produce similar result when using <code>multiprocessing.ThreadPool</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> multiprocessing <span style=color:#f92672>import</span> Pool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>func</span>(i):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> i
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>ori</span>():
</span></span><span style=display:flex><span>    <span style=color:#75715e># create many thread as time goes by, when i==300 cpu grow to 300%, run out of 16g ram and stuck I have to kill process</span>
</span></span><span style=display:flex><span>    p <span style=color:#f92672>=</span> Pool(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>append(p<span style=color:#f92672>.</span>map(func, range(<span style=color:#ae81ff>4</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>with_close</span>():
</span></span><span style=display:flex><span>    <span style=color:#75715e># 100% cpu, 0.1 ram, create 40 thread, takes 41s</span>
</span></span><span style=display:flex><span>    p <span style=color:#f92672>=</span> Pool(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>append(p<span style=color:#f92672>.</span>map(func, range(<span style=color:#ae81ff>4</span>)))
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>with_terminate</span>():
</span></span><span style=display:flex><span>    <span style=color:#75715e># 5% cpu, 0.1 ram, create 4 thread, takes 425s</span>
</span></span><span style=display:flex><span>    p <span style=color:#f92672>=</span> Pool(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>append(p<span style=color:#f92672>.</span>map(func, range(<span style=color:#ae81ff>4</span>)))
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>terminate()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>with_with</span>():
</span></span><span style=display:flex><span>    <span style=color:#75715e># same as terminate</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> Pool(<span style=color:#ae81ff>4</span>) <span style=color:#66d9ef>as</span> p:
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>append(p<span style=color:#f92672>.</span>map(func, range(<span style=color:#ae81ff>4</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>s <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time()
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>4000</span>):
</span></span><span style=display:flex><span>    ori()
</span></span><span style=display:flex><span>    <span style=color:#75715e># with_close()</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># with_terminate()</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># with_with()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> i <span style=color:#f92672>%</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        print(i)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;takes </span><span style=color:#e6db74>{</span>time<span style=color:#f92672>.</span>time() <span style=color:#f92672>-</span> s<span style=color:#e6db74>}</span><span style=color:#e6db74> seconds&#39;</span>)
</span></span></code></pre></div><p>As you can see, there are four functions. The <code>ori</code> function is <code>Pool</code> with no <code>close</code> and <code>terminate</code>, the RAM keeps growing and the script stuck. <code>with_close</code>, <code>with_terminate</code> and <code>with_with</code> will exit normally but time is different.</p><h2 id=why-close-is-faster-than-terminate>Why <code>close()</code> is faster than <code>terminate()</code>
<a class=heading-link href=#why-close-is-faster-than-terminate><i class="fa fa-link" aria-hidden=true></i></a></h2><p><code>Pool.terminate()</code> will call <code>terminate()</code> in each worker. <code>Pool.close()</code> just change the pool states and each worker will terminate itself. You can find the source code on <a href=https://github.com/python/cpython/blob/v3.6.8/Lib/multiprocessing/pool.py>GitHub</a>.</p><h2 id=verify-memory-leak>Verify Memory Leak
<a class=heading-link href=#verify-memory-leak><i class="fa fa-link" aria-hidden=true></i></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#f92672>import</span> gc
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> weakref
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> multiprocessing <span style=color:#f92672>import</span> Pool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>func</span>(i):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> i
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> Pool(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>wr <span style=color:#f92672>=</span> weakref<span style=color:#f92672>.</span>ref(p)
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>map(func, range(<span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>print(wr())
</span></span><span style=display:flex><span>print(gc<span style=color:#f92672>.</span>get_referents(wr()))
</span></span><span style=display:flex><span><span style=color:#75715e># p.close()</span>
</span></span><span style=display:flex><span><span style=color:#75715e># p.terminate()</span>
</span></span><span style=display:flex><span>time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>del</span> p
</span></span><span style=display:flex><span>gc<span style=color:#f92672>.</span>collect()
</span></span><span style=display:flex><span>print(wr())
</span></span><span style=display:flex><span>print(gc<span style=color:#f92672>.</span>get_referents(wr()))
</span></span></code></pre></div><p>If not calling <code>close</code> or <code>terminate</code>, after execution, <code>p</code> is still referred by some objects:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>&lt;multiprocessing.pool.Pool object at 0x7fc0e6db0828&gt;
</span></span><span style=display:flex><span>[{&#39;_ctx&#39;: &lt;multiprocessing.context.ForkContext object at 0x7fc0e6d455c0&gt;, &#39;_inqueue&#39;: &lt;multiprocessing.queues.SimpleQueue object at 0x7fc0e6db0860&gt;, &#39;_outqueue&#39;: &lt;multiprocessing.queues.SimpleQueue object at 0x7fc0e5babac8&gt;, &#39;_quick_put&#39;: &lt;bound method _ConnectionBase.send of &lt;multiprocessing.connection.Connection object at 0x7fc0e620e8d0&gt;&gt;, &#39;_quick_get&#39;: &lt;bound method _ConnectionBase.recv of &lt;multiprocessing.connection.Connection object at 0x7fc0e4d241d0&gt;&gt;, &#39;_taskqueue&#39;: &lt;queue.Queue object at 0x7fc0e4d24320&gt;, &#39;_cache&#39;: {}, &#39;_state&#39;: 0, &#39;_maxtasksperchild&#39;: None, &#39;_initializer&#39;: None, &#39;_initargs&#39;: (), &#39;_processes&#39;: 4, &#39;_pool&#39;: [&lt;ForkProcess(ForkPoolWorker-1, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-2, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-3, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-4, started daemon)&gt;], &#39;_worker_handler&#39;: &lt;Thread(Thread-1, started daemon 140466410379008)&gt;, &#39;_task_handler&#39;: &lt;Thread(Thread-2, started daemon 140466401986304)&gt;, &#39;_result_handler&#39;: &lt;Thread(Thread-3, started daemon 140466393593600)&gt;, &#39;_terminate&#39;: &lt;Finalize object, callback=_terminate_pool, args=(&lt;queue.Queue object at 0x7fc0e4d24320&gt;, &lt;multiprocessing.queues.SimpleQueue object at 0x7fc0e6db0860&gt;, &lt;multiprocessing.queues.SimpleQueue object at 0x7fc0e5babac8&gt;, [&lt;ForkProcess(ForkPoolWorker-1, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-2, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-3, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-4, started daemon)&gt;], &lt;Thread(Thread-1, started daemon 140466410379008)&gt;, &lt;Thread(Thread-2, started daemon 140466401986304)&gt;, &lt;Thread(Thread-3, started daemon 140466393593600)&gt;, {}), exitprority=15&gt;}, &lt;class &#39;multiprocessing.pool.Pool&#39;&gt;]
</span></span><span style=display:flex><span>&lt;multiprocessing.pool.Pool object at 0x7fc0e6db0828&gt;
</span></span><span style=display:flex><span>[{&#39;_ctx&#39;: &lt;multiprocessing.context.ForkContext object at 0x7fc0e6d455c0&gt;, &#39;_inqueue&#39;: &lt;multiprocessing.queues.SimpleQueue object at 0x7fc0e6db0860&gt;, &#39;_outqueue&#39;: &lt;multiprocessing.queues.SimpleQueue object at 0x7fc0e5babac8&gt;, &#39;_quick_put&#39;: &lt;bound method _ConnectionBase.send of &lt;multiprocessing.connection.Connection object at 0x7fc0e620e8d0&gt;&gt;, &#39;_quick_get&#39;: &lt;bound method _ConnectionBase.recv of &lt;multiprocessing.connection.Connection object at 0x7fc0e4d241d0&gt;&gt;, &#39;_taskqueue&#39;: &lt;queue.Queue object at 0x7fc0e4d24320&gt;, &#39;_cache&#39;: {}, &#39;_state&#39;: 0, &#39;_maxtasksperchild&#39;: None, &#39;_initializer&#39;: None, &#39;_initargs&#39;: (), &#39;_processes&#39;: 4, &#39;_pool&#39;: [&lt;ForkProcess(ForkPoolWorker-1, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-2, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-3, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-4, started daemon)&gt;], &#39;_worker_handler&#39;: &lt;Thread(Thread-1, started daemon 140466410379008)&gt;, &#39;_task_handler&#39;: &lt;Thread(Thread-2, started daemon 140466401986304)&gt;, &#39;_result_handler&#39;: &lt;Thread(Thread-3, started daemon 140466393593600)&gt;, &#39;_terminate&#39;: &lt;Finalize object, callback=_terminate_pool, args=(&lt;queue.Queue object at 0x7fc0e4d24320&gt;, &lt;multiprocessing.queues.SimpleQueue object at 0x7fc0e6db0860&gt;, &lt;multiprocessing.queues.SimpleQueue object at 0x7fc0e5babac8&gt;, [&lt;ForkProcess(ForkPoolWorker-1, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-2, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-3, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-4, started daemon)&gt;], &lt;Thread(Thread-1, started daemon 140466410379008)&gt;, &lt;Thread(Thread-2, started daemon 140466401986304)&gt;, &lt;Thread(Thread-3, started daemon 140466393593600)&gt;, {}), exitprority=15&gt;}, &lt;class &#39;multiprocessing.pool.Pool&#39;&gt;]
</span></span></code></pre></div><p>After calling <code>close()</code> or <code>terminate()</code>, the last two lines become:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>None
</span></span><span style=display:flex><span>[]
</span></span></code></pre></div><h2 id=document-update>Document Update
<a class=heading-link href=#document-update><i class="fa fa-link" aria-hidden=true></i></a></h2><p>The Python3.7 document adds this <a href=https://docs.python.org/3.7/library/multiprocessing.html#multiprocessing.pool.Pool>warning</a>:</p><blockquote><p><code>multiprocessing.pool</code> objects have internal resources that need to be properly managed (like any other resource) by using the pool as a context manager or by calling <code>close()</code> and <code>terminate()</code> manually. Failure to do this can lead to the process hanging on finalization.
Note that is not correct to rely on the garbage colletor to destroy the pool as CPython does not assure that the finalizer of the pool will be called (see <code>object.__del__()</code> for more information).</p></blockquote><h2 id=the-bug-is-fixed-in-python-3-dot-8>The Bug is Fixed in Python 3.8
<a class=heading-link href=#the-bug-is-fixed-in-python-3-dot-8><i class="fa fa-link" aria-hidden=true></i></a></h2><p>In python 3.8.6, the script exits normally and the total execution time also decreases without calling <code>close()</code>. I found this issue is fixed in Python bug tracker: <a href=https://bugs.python.org/issue34172>multiprocessing.Pool and ThreadPool leak resources after being deleted</a>.</p></div><footer><script src=https://utteranc.es/client.js repo=bebound/bebound.github.io issue-term=pathname label=comment theme=preferred-color-scheme crossorigin=anonymous async></script></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container>©
2022
KK
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=https://www.fromkk.com/js/coder.min.8fb86376a16e684af472a329aef502dbebcfab65ce264e9750d144912947c602.js integrity="sha256-j7hjdqFuaEr0cqMprvUC2+vPq2XOJk6XUNFEkSlHxgI="></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-153788833-1","auto"),ga("send","pageview"))</script></body></html>