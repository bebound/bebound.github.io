<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Memory Leak in Python multiprocessing.Pool - KK's Blog (fromkk)</title><meta name=Description content="fromkk.com is my personal blog, Explore insightful posts on Python, machine learning, and other stuff. keyword: python, machine learning, programming"><meta property="og:url" content="https://fromkk.com/posts/memory-leak-in-python-multiprocessing-dot-pool/"><meta property="og:site_name" content="KK's Blog (fromkk)"><meta property="og:title" content="Memory Leak in Python multiprocessing.Pool"><meta property="og:description" content="There is a historical memory leak problem in our Django app and I fixed it recently. As time goes by, the memory usage of app keeps growing and so does the CPU usage.
After some research, I figure out the cause. Some views does not close multiprocessing.Pool after using it. The problem disappears when I use Pool with with statement.
But I’m still interested in it and wrote some testing code. The script is run in Python 3.6.8 and produce similar result when using multiprocessing.ThreadPool."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-16T21:04:00+08:00"><meta property="article:modified_time" content="2025-07-18T19:07:21+08:00"><meta property="article:tag" content="Python"><meta property="og:image" content="https://fromkk.com/images/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fromkk.com/images/avatar.png"><meta name=twitter:title content="Memory Leak in Python multiprocessing.Pool"><meta name=twitter:description content="There is a historical memory leak problem in our Django app and I fixed it recently. As time goes by, the memory usage of app keeps growing and so does the CPU usage.
After some research, I figure out the cause. Some views does not close multiprocessing.Pool after using it. The problem disappears when I use Pool with with statement.
But I’m still interested in it and wrote some testing code. The script is run in Python 3.6.8 and produce similar result when using multiprocessing.ThreadPool."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://fromkk.com/posts/memory-leak-in-python-multiprocessing-dot-pool/><link rel=prev href=https://fromkk.com/posts/emacs-chinese-related-settings/><link rel=next href=https://fromkk.com/posts/how-to-copy-files-temporarily-in-dockerfile/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Memory Leak in Python multiprocessing.Pool","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/fromkk.com\/posts\/memory-leak-in-python-multiprocessing-dot-pool\/"},"genre":"posts","keywords":"Python","wordcount":717,"url":"https:\/\/fromkk.com\/posts\/memory-leak-in-python-multiprocessing-dot-pool\/","datePublished":"2022-03-16T21:04:00+08:00","dateModified":"2025-07-18T19:07:21+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"KK"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="KK's Blog (fromkk)"><span class=header-title-pre><img class='logo lazyautosizes ls-is-cached lazyloaded' src=/images/avatar.png></span>KK's Blog (fromkk)</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/bebound/bebound.github.io title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="KK's Blog (fromkk)"><span class=header-title-pre><img class='logo lazyautosizes ls-is-cached lazyloaded' src=/images/avatar.png></span>KK's Blog (fromkk)</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/bebound/bebound.github.io title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Memory Leak in Python multiprocessing.Pool</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>KK</a></span>&nbsp;<span class=post-category>included in <a href=/categories/programming/><i class="far fa-folder fa-fw" aria-hidden=true></i>Programming</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-03-16>2022-03-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;717 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;4 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#why-close-is-faster-than-terminate>Why <code>close()</code> is faster than <code>terminate()</code></a></li><li><a href=#verify-memory-leak>Verify Memory Leak</a></li><li><a href=#document-update>Document Update</a></li><li><a href=#the-bug-is-fixed-in-python-3-dot-8>The Bug is Fixed in Python 3.8</a></li></ul></nav></div></div><div class=content id=content><p>There is a historical memory leak problem in our Django app and I fixed it recently. As time goes by, the memory usage of app keeps growing and so does the CPU usage.</p><figure><img src=/images/pool_before.png></figure><p>After some research, I figure out the cause. Some views does not close <code>multiprocessing.Pool</code> after using it. The problem disappears when I use <code>Pool</code> with <code>with</code> statement.</p><figure><img src=/images/pool_after.png></figure><p>But I&rsquo;m still interested in it and wrote some testing code. The script is run in Python 3.6.8 and produce similar result when using <code>multiprocessing.ThreadPool</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> multiprocessing <span style=color:#f92672>import</span> Pool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>func</span>(i):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> i
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>ori</span>():
</span></span><span style=display:flex><span>    <span style=color:#75715e># create many thread as time goes by, when i==300 cpu grow to 300%, run out of 16g ram and stuck I have to kill process</span>
</span></span><span style=display:flex><span>    p <span style=color:#f92672>=</span> Pool(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>append(p<span style=color:#f92672>.</span>map(func, range(<span style=color:#ae81ff>4</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>with_close</span>():
</span></span><span style=display:flex><span>    <span style=color:#75715e># 100% cpu, 0.1 ram, create 40 thread, takes 41s</span>
</span></span><span style=display:flex><span>    p <span style=color:#f92672>=</span> Pool(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>append(p<span style=color:#f92672>.</span>map(func, range(<span style=color:#ae81ff>4</span>)))
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>with_terminate</span>():
</span></span><span style=display:flex><span>    <span style=color:#75715e># 5% cpu, 0.1 ram, create 4 thread, takes 425s</span>
</span></span><span style=display:flex><span>    p <span style=color:#f92672>=</span> Pool(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>append(p<span style=color:#f92672>.</span>map(func, range(<span style=color:#ae81ff>4</span>)))
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>terminate()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>with_with</span>():
</span></span><span style=display:flex><span>    <span style=color:#75715e># same as terminate</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> Pool(<span style=color:#ae81ff>4</span>) <span style=color:#66d9ef>as</span> p:
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>append(p<span style=color:#f92672>.</span>map(func, range(<span style=color:#ae81ff>4</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>s <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time()
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>4000</span>):
</span></span><span style=display:flex><span>    ori()
</span></span><span style=display:flex><span>    <span style=color:#75715e># with_close()</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># with_terminate()</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># with_with()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> i <span style=color:#f92672>%</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        print(i)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;takes </span><span style=color:#e6db74>{</span>time<span style=color:#f92672>.</span>time() <span style=color:#f92672>-</span> s<span style=color:#e6db74>}</span><span style=color:#e6db74> seconds&#39;</span>)
</span></span></code></pre></div><p>As you can see, there are four functions. The <code>ori</code> function is <code>Pool</code> with no <code>close</code> and <code>terminate</code>, the RAM keeps growing and the script stuck. <code>with_close</code>, <code>with_terminate</code> and <code>with_with</code> will exit normally but time is different.</p><h2 id=why-close-is-faster-than-terminate>Why <code>close()</code> is faster than <code>terminate()</code></h2><p><code>Pool.terminate()</code> will call <code>terminate()</code> in each worker. <code>Pool.close()</code> just change the pool states and each worker will terminate itself. You can find the source code on <a href=https://github.com/python/cpython/blob/v3.6.8/Lib/multiprocessing/pool.py target=_blank rel="noopener noreffer">GitHub</a>.</p><h2 id=verify-memory-leak>Verify Memory Leak</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#f92672>import</span> gc
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> weakref
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> multiprocessing <span style=color:#f92672>import</span> Pool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>func</span>(i):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> i
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> Pool(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>wr <span style=color:#f92672>=</span> weakref<span style=color:#f92672>.</span>ref(p)
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>map(func, range(<span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>print(wr())
</span></span><span style=display:flex><span>print(gc<span style=color:#f92672>.</span>get_referents(wr()))
</span></span><span style=display:flex><span><span style=color:#75715e># p.close()</span>
</span></span><span style=display:flex><span><span style=color:#75715e># p.terminate()</span>
</span></span><span style=display:flex><span>time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>del</span> p
</span></span><span style=display:flex><span>gc<span style=color:#f92672>.</span>collect()
</span></span><span style=display:flex><span>print(wr())
</span></span><span style=display:flex><span>print(gc<span style=color:#f92672>.</span>get_referents(wr()))
</span></span></code></pre></div><p>If not calling <code>close</code> or <code>terminate</code>, after execution, <code>p</code> is still referred by some objects:</p><pre tabindex=0><code class=language-nil data-lang=nil>&lt;multiprocessing.pool.Pool object at 0x7fc0e6db0828&gt;
[{&#39;_ctx&#39;: &lt;multiprocessing.context.ForkContext object at 0x7fc0e6d455c0&gt;, &#39;_inqueue&#39;: &lt;multiprocessing.queues.SimpleQueue object at 0x7fc0e6db0860&gt;, &#39;_outqueue&#39;: &lt;multiprocessing.queues.SimpleQueue object at 0x7fc0e5babac8&gt;, &#39;_quick_put&#39;: &lt;bound method _ConnectionBase.send of &lt;multiprocessing.connection.Connection object at 0x7fc0e620e8d0&gt;&gt;, &#39;_quick_get&#39;: &lt;bound method _ConnectionBase.recv of &lt;multiprocessing.connection.Connection object at 0x7fc0e4d241d0&gt;&gt;, &#39;_taskqueue&#39;: &lt;queue.Queue object at 0x7fc0e4d24320&gt;, &#39;_cache&#39;: {}, &#39;_state&#39;: 0, &#39;_maxtasksperchild&#39;: None, &#39;_initializer&#39;: None, &#39;_initargs&#39;: (), &#39;_processes&#39;: 4, &#39;_pool&#39;: [&lt;ForkProcess(ForkPoolWorker-1, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-2, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-3, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-4, started daemon)&gt;], &#39;_worker_handler&#39;: &lt;Thread(Thread-1, started daemon 140466410379008)&gt;, &#39;_task_handler&#39;: &lt;Thread(Thread-2, started daemon 140466401986304)&gt;, &#39;_result_handler&#39;: &lt;Thread(Thread-3, started daemon 140466393593600)&gt;, &#39;_terminate&#39;: &lt;Finalize object, callback=_terminate_pool, args=(&lt;queue.Queue object at 0x7fc0e4d24320&gt;, &lt;multiprocessing.queues.SimpleQueue object at 0x7fc0e6db0860&gt;, &lt;multiprocessing.queues.SimpleQueue object at 0x7fc0e5babac8&gt;, [&lt;ForkProcess(ForkPoolWorker-1, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-2, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-3, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-4, started daemon)&gt;], &lt;Thread(Thread-1, started daemon 140466410379008)&gt;, &lt;Thread(Thread-2, started daemon 140466401986304)&gt;, &lt;Thread(Thread-3, started daemon 140466393593600)&gt;, {}), exitprority=15&gt;}, &lt;class &#39;multiprocessing.pool.Pool&#39;&gt;]
&lt;multiprocessing.pool.Pool object at 0x7fc0e6db0828&gt;
[{&#39;_ctx&#39;: &lt;multiprocessing.context.ForkContext object at 0x7fc0e6d455c0&gt;, &#39;_inqueue&#39;: &lt;multiprocessing.queues.SimpleQueue object at 0x7fc0e6db0860&gt;, &#39;_outqueue&#39;: &lt;multiprocessing.queues.SimpleQueue object at 0x7fc0e5babac8&gt;, &#39;_quick_put&#39;: &lt;bound method _ConnectionBase.send of &lt;multiprocessing.connection.Connection object at 0x7fc0e620e8d0&gt;&gt;, &#39;_quick_get&#39;: &lt;bound method _ConnectionBase.recv of &lt;multiprocessing.connection.Connection object at 0x7fc0e4d241d0&gt;&gt;, &#39;_taskqueue&#39;: &lt;queue.Queue object at 0x7fc0e4d24320&gt;, &#39;_cache&#39;: {}, &#39;_state&#39;: 0, &#39;_maxtasksperchild&#39;: None, &#39;_initializer&#39;: None, &#39;_initargs&#39;: (), &#39;_processes&#39;: 4, &#39;_pool&#39;: [&lt;ForkProcess(ForkPoolWorker-1, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-2, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-3, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-4, started daemon)&gt;], &#39;_worker_handler&#39;: &lt;Thread(Thread-1, started daemon 140466410379008)&gt;, &#39;_task_handler&#39;: &lt;Thread(Thread-2, started daemon 140466401986304)&gt;, &#39;_result_handler&#39;: &lt;Thread(Thread-3, started daemon 140466393593600)&gt;, &#39;_terminate&#39;: &lt;Finalize object, callback=_terminate_pool, args=(&lt;queue.Queue object at 0x7fc0e4d24320&gt;, &lt;multiprocessing.queues.SimpleQueue object at 0x7fc0e6db0860&gt;, &lt;multiprocessing.queues.SimpleQueue object at 0x7fc0e5babac8&gt;, [&lt;ForkProcess(ForkPoolWorker-1, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-2, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-3, started daemon)&gt;, &lt;ForkProcess(ForkPoolWorker-4, started daemon)&gt;], &lt;Thread(Thread-1, started daemon 140466410379008)&gt;, &lt;Thread(Thread-2, started daemon 140466401986304)&gt;, &lt;Thread(Thread-3, started daemon 140466393593600)&gt;, {}), exitprority=15&gt;}, &lt;class &#39;multiprocessing.pool.Pool&#39;&gt;]
</code></pre><p>After calling <code>close()</code> or <code>terminate()</code>, the last two lines become:</p><pre tabindex=0><code class=language-nil data-lang=nil>None
[]
</code></pre><h2 id=document-update>Document Update</h2><p>The Python3.7 document adds this <a href=https://docs.python.org/3.7/library/multiprocessing.html#multiprocessing.pool.Pool target=_blank rel="noopener noreffer">warning</a>:</p><blockquote><p><code>multiprocessing.pool</code> objects have internal resources that need to be properly managed (like any other resource) by using the pool as a context manager or by calling <code>close()</code> and <code>terminate()</code> manually. Failure to do this can lead to the process hanging on finalization.
Note that is not correct to rely on the garbage collector to destroy the pool as CPython does not assure that the finalizer of the pool will be called (see <code>object.__del__()</code> for more information).</p></blockquote><h2 id=the-bug-is-fixed-in-python-3-dot-8>The Bug is Fixed in Python 3.8</h2><p>In python 3.8.6, the script exits normally and the total execution time also decreases without calling <code>close()</code>. I found this issue is fixed in Python bug tracker: <a href=https://bugs.python.org/issue34172 target=_blank rel="noopener noreffer">multiprocessing.Pool and ThreadPool leak resources after being deleted</a>.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2025-07-18</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://fromkk.com/posts/memory-leak-in-python-multiprocessing-dot-pool/ data-title="Memory Leak in Python multiprocessing.Pool" data-hashtags=Python><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://fromkk.com/posts/memory-leak-in-python-multiprocessing-dot-pool/ data-hashtag=Python><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://fromkk.com/posts/memory-leak-in-python-multiprocessing-dot-pool/ data-title="Memory Leak in Python multiprocessing.Pool"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://fromkk.com/posts/memory-leak-in-python-multiprocessing-dot-pool/ data-title="Memory Leak in Python multiprocessing.Pool"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://fromkk.com/posts/memory-leak-in-python-multiprocessing-dot-pool/ data-title="Memory Leak in Python multiprocessing.Pool"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/python/>Python</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/emacs-chinese-related-settings/ class=prev rel=prev title="Emacs Chinese-related Settings"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Emacs Chinese-related Settings</a>
<a href=/posts/how-to-copy-files-temporarily-in-dockerfile/ class=next rel=next title="How to copy files temporarily in Dockerfile">How to copy files temporarily in Dockerfile<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.148.1">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.3.0"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>KK</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>