<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=color-scheme content="light dark"><meta name=author content="KK"><meta name=description content="Python supports multiple inheritance, its class can be derived from more than one base classes. If the specified attribute or methods was not found in current class, how to decide the search sequence from superclasses? In simple scenario, we know left-to right, bottom to up. But when the inheritance hierarchy become complicated, it&rsquo;s not easy to answer by intuition.
For instance, what&rsquo;s search sequence of class M?
class X:pass class Y: pass class Z:pass class A(X,Y):pass class B(Y,Z):pass class M(B,A,Z):pass  The answer is: M, B, A, X, Y, Z, object"><meta name=keywords content="fromkk,blog,kk blog,developer,personal,python,golang,go,linux,machine learning"><meta name=twitter:card content="summary"><meta name=twitter:title content="C3 Linearization and Python MRO(Method Resolution Order)"><meta name=twitter:description content="Python supports multiple inheritance, its class can be derived from more than one base classes. If the specified attribute or methods was not found in current class, how to decide the search sequence from superclasses? In simple scenario, we know left-to right, bottom to up. But when the inheritance hierarchy become complicated, it&rsquo;s not easy to answer by intuition.
For instance, what&rsquo;s search sequence of class M?
class X:pass class Y: pass class Z:pass class A(X,Y):pass class B(Y,Z):pass class M(B,A,Z):pass  The answer is: M, B, A, X, Y, Z, object"><meta property="og:title" content="C3 Linearization and Python MRO(Method Resolution Order)"><meta property="og:description" content="Python supports multiple inheritance, its class can be derived from more than one base classes. If the specified attribute or methods was not found in current class, how to decide the search sequence from superclasses? In simple scenario, we know left-to right, bottom to up. But when the inheritance hierarchy become complicated, it&rsquo;s not easy to answer by intuition.
For instance, what&rsquo;s search sequence of class M?
class X:pass class Y: pass class Z:pass class A(X,Y):pass class B(Y,Z):pass class M(B,A,Z):pass  The answer is: M, B, A, X, Y, Z, object"><meta property="og:type" content="article"><meta property="og:url" content="https://www.fromkk.com/posts/c3-linearization-and-python-mro--method-resolution-order/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-14T17:37:00+08:00"><meta property="article:modified_time" content="2022-01-06T21:24:31+08:00"><title>C3 Linearization and Python MRO(Method Resolution Order) · KK's Blog (fromkk)</title><link rel=canonical href=https://www.fromkk.com/posts/c3-linearization-and-python-mro--method-resolution-order/><link rel=preload href="https://www.fromkk.com/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://www.fromkk.com/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css integrity="sha256-2f3b/+byfmmYXcX+BHHNsOV/v0d1cUvD2Eesywj0ofY=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://www.fromkk.com/css/coder-dark.min.002ee2378e14c7a68f1f0a53d9694ed252090987c4e768023fac694a4fc5f793.css integrity="sha256-AC7iN44Ux6aPHwpT2WlO0lIJCYfE52gCP6xpSk/F95M=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://www.fromkk.com/icons/icon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://www.fromkk.com/icons/icon-16x16.png sizes=16x16><link rel=apple-touch-icon href=https://www.fromkk.com/icons/icon-192x192.png><link rel=apple-touch-icon sizes=180x180 href=https://www.fromkk.com/icons/icon-192x192.png><meta name=generator content="Hugo 0.94.2"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://www.fromkk.com/>KK's Blog (fromkk)</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/posts/index.xml>RSS</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://www.fromkk.com/posts/c3-linearization-and-python-mro--method-resolution-order/>C3 Linearization and Python MRO(Method Resolution Order)</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2020-03-14T17:37:00+08:00>03/14/2020</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
3-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=https://www.fromkk.com/tags/python/>Python</a></span>
<span class=separator>•</span>
<span class=tag><a href=https://www.fromkk.com/tags/mro/>MRO</a></span></div></div></header><div><p>Python supports multiple inheritance, its class can be derived from more than one base classes. If the specified attribute or methods was not found in current class, how to decide the search sequence from superclasses? In simple scenario, we know left-to right, bottom to up. But when the inheritance hierarchy become complicated, it&rsquo;s not easy to answer by intuition.</p><p>For instance, what&rsquo;s search sequence of class M?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>X</span>:<span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Y</span>: <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Z</span>:<span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>A</span>(X,Y):<span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>B</span>(Y,Z):<span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>M</span>(B,A,Z):<span style=color:#66d9ef>pass</span>
</span></span></code></pre></div><figure><img src=https://www.fromkk.com/images/python_mro.png width=400></figure><p>The answer is: <code>M, B, A, X, Y, Z, object</code></p><h2 id=c3-algorithm>C3 Algorithm
<a class=heading-link href=#c3-algorithm><i class="fa fa-link" aria-hidden=true></i></a></h2><p>How did Python generate this sequence? After Python 2.3, it use <code>C3 Linearization</code> algorithm.</p><p>C3 follows these two equation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>L[object] = [object]
</span></span><span style=display:flex><span>L[C(B1…BN)] = [C] + merge(L[B1]…L[BN], [B1, … ,BN])
</span></span></code></pre></div><p><code>L[C]</code> is the MRO of class C, it will evaluate to a list.</p><p>The key process is <strong>merge</strong>, it get a list and generate a list by this way:</p><ol><li>First, check the first list&rsquo;s head element(<code>L[B1]</code>) as H.</li><li>If H is not in the tail of other list, output it, and remove it from all of the list, then go to step 1. Otherwise, check the next list&rsquo;s head as H, go to step 2. (tail means the rest of the list except the first element)</li><li>If <strong>merge</strong>&rsquo;s list is empty, end algorithm. If list is not empty but not able to find element to output, raise error.</li></ol><p>That seems complicated, I&rsquo;ll use the previous example again to explain the calculation of C3.</p><p>Let&rsquo;s begin with the easy ones. Firstly, calculate <code>A</code>&rsquo;s MRO:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>L[A(X,Y)]=[A]+merge(L[X],L[Y],[X,Y])
</span></span><span style=display:flex><span>         =[A]+merge([X,obj],[Y,obj],[X,Y])
</span></span><span style=display:flex><span>         # X is not tail of other list, use it as H
</span></span><span style=display:flex><span>         =[A,X]+merge([obj],[Y,obj],[Y])
</span></span><span style=display:flex><span>         # obj is in the tail of[Y.obj], use Y as H
</span></span><span style=display:flex><span>         =[A,X,Y]+merge([obj],[obj]]
</span></span><span style=display:flex><span>         =[A,X,Y,obj]
</span></span></code></pre></div><p><code>B</code>&rsquo;s MRO <code>[B,Y,Z,obj]</code> and <code>Z</code>&rsquo;s MRO <code>[z,obj]</code> can also be calculated.</p><p>Now we can get <code>M</code>&rsquo;s MRO:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>L[M(B,A,Z)]=[M]+merge(L[B],L[A],L[Z],[B,A,Z])
</span></span><span style=display:flex><span>         =[M]+merge([B,Y,Z,obj],[A,X,Y,obj],[Z,obj],[B,A,Z])
</span></span><span style=display:flex><span>         =[M,B]+merge([Y,Z,obj],[A,X,Y,obj],[Z,obj],[A,Z])
</span></span><span style=display:flex><span>         # Y is in the tail of [A,X,Y,obj], use A as H
</span></span><span style=display:flex><span>         =[M,B,A]+merge([Y,Z,obj],[X,Y,obj],[Z,obj],[Z])
</span></span><span style=display:flex><span>         # Y is in the tail of [X,Y,obj], use X as H
</span></span><span style=display:flex><span>         =[M,B,A,X]+merge([Y,Z,obj],[Y,obj],[Z,obj],[Z])
</span></span><span style=display:flex><span>         =[M,B,A,X,Y]+merge([Z,obj],[obj],[Z,obj],[Z])
</span></span><span style=display:flex><span>         =[M,B,A,X,Y,X]+merge([obj],[obj],[obj])
</span></span><span style=display:flex><span>         =[M,B,A,X,Y,X,obj]
</span></span></code></pre></div><h2 id=mro-and-super>MRO and super()
<a class=heading-link href=#mro-and-super><i class="fa fa-link" aria-hidden=true></i></a></h2><p><code>super</code> also use C3 to find the inherited method to execute.</p><p>For instance, <code>C</code>&rsquo;s MRO is <code>C,A,B,Base,obj</code>, so after <code>enter A</code>, it will output <code>enter B</code> rather than <code>enter base</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Base</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;enter base&#39;</span>)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;leave base&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>A</span>(Base):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;enter A&#39;</span>)
</span></span><span style=display:flex><span>        super(A, self)<span style=color:#f92672>.</span>__init__()
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;leave A&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>B</span>(Base):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;enter B&#39;</span>)
</span></span><span style=display:flex><span>        super(B, self)<span style=color:#f92672>.</span>__init__()
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;leave B&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>C</span>(A, B):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;enter C&#39;</span>)
</span></span><span style=display:flex><span>        super(C, self)<span style=color:#f92672>.</span>__init__()
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;leave C&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>c <span style=color:#f92672>=</span> C()
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>enter C
</span></span><span style=display:flex><span>enter A
</span></span><span style=display:flex><span>enter B
</span></span><span style=display:flex><span>enter base
</span></span><span style=display:flex><span>leave base
</span></span><span style=display:flex><span>leave B
</span></span><span style=display:flex><span>leave A
</span></span><span style=display:flex><span>leave C
</span></span></code></pre></div><p><code>super</code> works like this, it will get <code>inst</code>&rsquo;s MRO, find <code>cls</code>&rsquo;s index, return next class in MRO. (In python3, <code>super(A,self)</code> can be write as <code>super()</code>)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>super</span>(cls, inst):
</span></span><span style=display:flex><span>    mro <span style=color:#f92672>=</span> inst<span style=color:#f92672>.</span>__class__<span style=color:#f92672>.</span>mro()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> mro[mro<span style=color:#f92672>.</span>index(cls) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>]
</span></span></code></pre></div><p>When running this line <code>super(C, self).__init__()</code>, self is <code>C</code>&rsquo;s instance, mro is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[&lt;class &#39;__main__.C&#39;&gt;, &lt;class &#39;__main__.A&#39;&gt;, &lt;class &#39;__main__.B&#39;&gt;, &lt;class &#39;__main__.Base&#39;&gt;, &lt;class &#39;object&#39;&gt;]
</span></span></code></pre></div><p>So it returns <code>A</code>, and A will execute <code>__init__()</code>, then calling <code>super(A, self).__init__()</code>, end enter <code>B</code>&rsquo;s <code>__init__()</code>. (<code>C</code>&rsquo;s instance <code>inst</code> will pass as <code>self</code> in the calling chain.)</p><h2 id=ref>Ref:
<a class=heading-link href=#ref><i class="fa fa-link" aria-hidden=true></i></a></h2><ol><li><a href=https://www.python.org/download/releases/2.3/mro/>The Python 2.3 Method Resolution Order</a></li><li><a href=https://www.programiz.com/python-programming/multiple-inheritance>Python Multiple Inheritance</a></li><li><a href=https://www.jianshu.com/p/de7d38c84443>python之理解super及MRO列表</a></li><li><a href=https://www.cnblogs.com/miyauchi-renge/p/10922092.html>Python的MRO以及C3线性化算法</a></li><li><a href=https://en.wikipedia.org/wiki/C3%5Flinearization>C3 linearization</a></li></ol></div><footer><script src=https://utteranc.es/client.js repo=bebound/bebound.github.io issue-term=pathname label=comment theme=preferred-color-scheme crossorigin=anonymous async></script></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container>©
2022
KK
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=https://www.fromkk.com/js/coder.min.8fb86376a16e684af472a329aef502dbebcfab65ce264e9750d144912947c602.js integrity="sha256-j7hjdqFuaEr0cqMprvUC2+vPq2XOJk6XUNFEkSlHxgI="></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-153788833-1","auto"),ga("send","pageview"))</script></body></html>