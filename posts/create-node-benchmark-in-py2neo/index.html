<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=author content="KK"><meta name=description content="Recently, I&rsquo;m working on a neo4j project. I use Py2neo to interact with graph db. Alghough Py2neo is a very pythonic and easy to use, its performance is really poor. Sometimes I have to manually write cypher statement by myself if I can&rsquo;t bear with the slow excution. Here is a small script which I use to compare the performance of 4 diffrent ways to insert nodes.
import time from graph_db import graph from py2neo."><meta name=keywords content="fromkk,blog,kk blog,developer,personal,python,golang,go,linux,machine learning"><meta name=twitter:card content="summary"><meta name=twitter:title content="Create Node Benchmark in Py2neo"><meta name=twitter:description content="Recently, I&rsquo;m working on a neo4j project. I use Py2neo to interact with graph db. Alghough Py2neo is a very pythonic and easy to use, its performance is really poor. Sometimes I have to manually write cypher statement by myself if I can&rsquo;t bear with the slow excution. Here is a small script which I use to compare the performance of 4 diffrent ways to insert nodes.
import time from graph_db import graph from py2neo."><meta property="og:title" content="Create Node Benchmark in Py2neo"><meta property="og:description" content="Recently, I&rsquo;m working on a neo4j project. I use Py2neo to interact with graph db. Alghough Py2neo is a very pythonic and easy to use, its performance is really poor. Sometimes I have to manually write cypher statement by myself if I can&rsquo;t bear with the slow excution. Here is a small script which I use to compare the performance of 4 diffrent ways to insert nodes.
import time from graph_db import graph from py2neo."><meta property="og:type" content="article"><meta property="og:url" content="https://www.fromkk.com/posts/create-node-benchmark-in-py2neo/"><meta property="article:published_time" content="2018-11-05T15:55:00+08:00"><meta property="article:modified_time" content="2019-11-29T00:29:06+08:00"><base href=https://www.fromkk.com/posts/create-node-benchmark-in-py2neo/><title>Create Node Benchmark in Py2neo Â· KK's Blog (fromkk)</title><link rel=canonical href=https://www.fromkk.com/posts/create-node-benchmark-in-py2neo/><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.13.0/css/all.css integrity=sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://www.fromkk.com/css/coder.min.fce3d3684e836ce340cdd591dad1749c310472d5ed4049fab99845c9aec4d4bf.css integrity="sha256-/OPTaE6DbONAzdWR2tF0nDEEctXtQEn6uZhFya7E1L8=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://www.fromkk.com/css/custom.css><link rel=icon type=image/png href=https://www.fromkk.com/icons/icon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://www.fromkk.com/icons/icon-16x16.png sizes=16x16><link rel=apple-touch-icon href=https://www.fromkk.com/icons/icon-192x192.png><link rel=apple-touch-icon sizes=180x180 href=https://www.fromkk.com/icons/icon-192x192.png><meta name=generator content="Hugo 0.68.3"></head><body class=colorscheme-light><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://www.fromkk.com/>KK's Blog (fromkk)</a>
<span id=dark-mode-toggle class=float-right><i class="fas fa-adjust fa-fw"></i></span><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fas fa-bars fa-fw"></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/posts/index.xml>RSS</a></li><li class="navigation-item separator"><span>|</span></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Create Node Benchmark in Py2neo</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i><time datetime=2018-11-05T15:55:00+08:00>11/05/2018</time></span>
<span class=reading-time><i class="fas fa-clock"></i>2-minute read</span></div><div class=tags><i class="fas fa-tag"></i><a href=https://www.fromkk.com/tags/python/>Python</a></div></div></header><div><p>Recently, I&rsquo;m working on a neo4j project. I use <code>Py2neo</code> to interact with graph db. Alghough <code>Py2neo</code> is a very pythonic and easy to use, its performance is really poor. Sometimes I have to manually write cypher statement by myself if I can&rsquo;t bear with the slow excution. Here is a small script which I use to compare the performance of 4 diffrent ways to insert nodes.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> time

<span style=color:#f92672>from</span> graph_db <span style=color:#f92672>import</span> graph

<span style=color:#f92672>from</span> py2neo.data <span style=color:#f92672>import</span> Node, Subgraph


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>delete_label</span>(label):
    graph<span style=color:#f92672>.</span>run(<span style=color:#e6db74>&#39;MATCH (n:{}) DETACH DELETE n&#39;</span><span style=color:#f92672>.</span>format(label))


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>delete_all</span>():
    <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;delete all&#39;</span>)
    graph<span style=color:#f92672>.</span>run(<span style=color:#e6db74>&#39;match (n) detach delete n&#39;</span>)


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>count_label</span>(label):
    <span style=color:#66d9ef>return</span> len(graph<span style=color:#f92672>.</span>nodes<span style=color:#f92672>.</span>match(label))


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bench_create1</span>():
    <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;Using py2neo one by one&#39;</span>)
    delete_label(<span style=color:#e6db74>&#39;test&#39;</span>)
    start <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time()
    tx <span style=color:#f92672>=</span> graph<span style=color:#f92672>.</span>begin()
    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>100000</span>):
        n <span style=color:#f92672>=</span> Node(<span style=color:#e6db74>&#39;test&#39;</span>, id<span style=color:#f92672>=</span>i)
        tx<span style=color:#f92672>.</span>create(n)
    tx<span style=color:#f92672>.</span>commit()
    <span style=color:#66d9ef>print</span>(time<span style=color:#f92672>.</span>time() <span style=color:#f92672>-</span> start)
    <span style=color:#66d9ef>print</span>(count_label(<span style=color:#e6db74>&#39;test&#39;</span>))
    delete_label(<span style=color:#e6db74>&#39;test&#39;</span>)


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bench_create2</span>():
    <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;Using cypher one by one&#39;</span>)
    delete_label(<span style=color:#e6db74>&#39;test&#39;</span>)
    start <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time()
    tx <span style=color:#f92672>=</span> graph<span style=color:#f92672>.</span>begin()
    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>100000</span>):
        tx<span style=color:#f92672>.</span>run(<span style=color:#e6db74>&#39;create (n:test {id: $id})&#39;</span>, id<span style=color:#f92672>=</span>i)
        <span style=color:#66d9ef>if</span> i <span style=color:#f92672>and</span> i <span style=color:#f92672>%</span> <span style=color:#ae81ff>1000</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
            tx<span style=color:#f92672>.</span>commit()
            tx <span style=color:#f92672>=</span> graph<span style=color:#f92672>.</span>begin()
    tx<span style=color:#f92672>.</span>commit()
    <span style=color:#66d9ef>print</span>(time<span style=color:#f92672>.</span>time() <span style=color:#f92672>-</span> start)
    <span style=color:#66d9ef>print</span>(count_label(<span style=color:#e6db74>&#39;test&#39;</span>))
    delete_label(<span style=color:#e6db74>&#39;test&#39;</span>)


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bench_create3</span>():
    <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;Using Subgraph&#39;</span>)
    delete_label(<span style=color:#e6db74>&#39;test&#39;</span>)
    start <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time()
    tx <span style=color:#f92672>=</span> graph<span style=color:#f92672>.</span>begin()
    nodes <span style=color:#f92672>=</span> []
    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>100000</span>):
        nodes<span style=color:#f92672>.</span>append(Node(<span style=color:#e6db74>&#39;test&#39;</span>, id<span style=color:#f92672>=</span>i))
    s <span style=color:#f92672>=</span> Subgraph(nodes<span style=color:#f92672>=</span>nodes)
    tx<span style=color:#f92672>.</span>create(s)
    tx<span style=color:#f92672>.</span>commit()
    <span style=color:#66d9ef>print</span>(time<span style=color:#f92672>.</span>time() <span style=color:#f92672>-</span> start)
    <span style=color:#66d9ef>print</span>(count_label(<span style=color:#e6db74>&#39;test&#39;</span>))
    delete_label(<span style=color:#e6db74>&#39;test&#39;</span>)


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bench_create4</span>():
    <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;Using unwind&#39;</span>)
    delete_label(<span style=color:#e6db74>&#39;test&#39;</span>)
    start <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time()
    tx <span style=color:#f92672>=</span> graph<span style=color:#f92672>.</span>begin()
    ids <span style=color:#f92672>=</span> list(range(<span style=color:#ae81ff>100000</span>))
    tx<span style=color:#f92672>.</span>run(<span style=color:#e6db74>&#39;unwind $ids as id create (n:test {id: id})&#39;</span>, ids<span style=color:#f92672>=</span>ids)
    tx<span style=color:#f92672>.</span>commit()
    <span style=color:#66d9ef>print</span>(time<span style=color:#f92672>.</span>time() <span style=color:#f92672>-</span> start)
    <span style=color:#66d9ef>print</span>(count_label(<span style=color:#e6db74>&#39;test&#39;</span>))
    delete_label(<span style=color:#e6db74>&#39;test&#39;</span>)


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bench_create</span>():
    create_tests <span style=color:#f92672>=</span> [bench_create1, bench_create2, bench_create3, bench_create4]

    <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;testing create&#39;</span>)
    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> create_tests:
        i()


<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
    bench_create()
</code></pre></div><p>Apparently, using cypher with <code>unwind</code> keyword is the fastest way to batch insert nodes.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>testing create
Using py2neo one by one
96.09799289703369
100000
Using cypher one by one
9.493892192840576
100000
Using Subgraph
7.638832092285156
100000
Using unwind
2.511630058288574
100000
</code></pre></div><p>The above result is based on <code>http</code> protocol. A very interesting result is that, <code>bolt</code> protocol will decrease the time of the first method, but double the time of sencond method. That&rsquo;s wired, maybe <code>py2neo</code> has some special opitimization when doing batch insert on <code>bolt</code> protocol? But I have no idea why insert one by one with cypher is 2x slower. Here is the result of <code>bolt</code> protocol.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>testing create
Using py2neo one by one
51.73185706138611
100000
Using cypher one by one
22.051995992660522
100000
Using Subgraph
8.81674599647522
100000
Using unwind
2.8623900413513184
100000
</code></pre></div></div><footer><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"kkblog-1"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js id=MathJax-script></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};</script></section></div><footer class=footer><section class=container>Â©
2020
KK
Â·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=https://www.fromkk.com/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-153788833-1','auto');ga('send','pageview');}</script></body></html>