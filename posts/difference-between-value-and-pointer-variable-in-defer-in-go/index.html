<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=author content="KK"><meta name=description content="defer is a useful function to do cleanup, as it will execute in LIFO order before the surrounding function returns. If you don&rsquo;t know how it works, sometimes the execution result may confuse you.
How it Works and Why Value or Pointer Receiver Matters I found an interesting code on Stack Overflow:
type X struct { S string } func (x X) Close() { fmt.Println(&#34;Value-Closing&#34;, x.S) } func (x *X) CloseP() { fmt."><meta name=keywords content="fromkk,blog,kk blog,developer,personal,python,golang,go,linux,machine learning"><meta name=twitter:card content="summary"><meta name=twitter:title content="Difference between Value and Pointer variable in Defer in Go"><meta name=twitter:description content="defer is a useful function to do cleanup, as it will execute in LIFO order before the surrounding function returns. If you don&rsquo;t know how it works, sometimes the execution result may confuse you.
How it Works and Why Value or Pointer Receiver Matters I found an interesting code on Stack Overflow:
type X struct { S string } func (x X) Close() { fmt.Println(&#34;Value-Closing&#34;, x.S) } func (x *X) CloseP() { fmt."><meta property="og:title" content="Difference between Value and Pointer variable in Defer in Go"><meta property="og:description" content="defer is a useful function to do cleanup, as it will execute in LIFO order before the surrounding function returns. If you don&rsquo;t know how it works, sometimes the execution result may confuse you.
How it Works and Why Value or Pointer Receiver Matters I found an interesting code on Stack Overflow:
type X struct { S string } func (x X) Close() { fmt.Println(&#34;Value-Closing&#34;, x.S) } func (x *X) CloseP() { fmt."><meta property="og:type" content="article"><meta property="og:url" content="https://www.fromkk.com/posts/difference-between-value-and-pointer-variable-in-defer-in-go/"><meta property="article:published_time" content="2019-12-19T22:33:00+08:00"><meta property="article:modified_time" content="2020-08-01T00:39:56+08:00"><title>Difference between Value and Pointer variable in Defer in Go · KK's Blog (fromkk)</title><link rel=canonical href=https://www.fromkk.com/posts/difference-between-value-and-pointer-variable-in-defer-in-go/><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css integrity="sha256-gsmEoJAws/Kd3CjuOQzLie5Q3yshhvmo7YNtBG7aaEY=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://www.fromkk.com/css/coder.min.9836c03fe5c87d102278a33e86d0591ef36c89b1e17e8e547ebf84c05cee010e.css integrity="sha256-mDbAP+XIfRAieKM+htBZHvNsibHhfo5Ufr+EwFzuAQ4=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://www.fromkk.com/css/coder-dark.min.717236c74e0a5208ef73964a9f44c6b443b689a95b270d8b2a40d0c012460dac.css integrity="sha256-cXI2x04KUgjvc5ZKn0TGtEO2ialbJw2LKkDQwBJGDaw=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://www.fromkk.com/icons/icon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://www.fromkk.com/icons/icon-16x16.png sizes=16x16><link rel=apple-touch-icon href=https://www.fromkk.com/icons/icon-192x192.png><link rel=apple-touch-icon sizes=180x180 href=https://www.fromkk.com/icons/icon-192x192.png><meta name=generator content="Hugo 0.68.3"></head><body class=colorscheme-auto><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://www.fromkk.com/>KK's Blog (fromkk)</a>
<span id=dark-mode-toggle class=float-right><i class="fa fa-adjust fa-fw" aria-hidden=true></i></span><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/posts/index.xml>RSS</a></li><li class="navigation-item separator"><span>|</span></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Difference between Value and Pointer variable in Defer in Go</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2019-12-19T22:33:00+08:00>12/19/2019</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>3-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i><a href=https://www.fromkk.com/tags/go/>Go</a>
<span class=separator>•</span>
<a href=https://www.fromkk.com/tags/defer/>Defer</a></div></div></header><div><p><code>defer</code> is a useful function to do cleanup, as it will execute in LIFO order before the surrounding function returns. If you don&rsquo;t know how it works, sometimes the execution result may confuse you.</p><h2 id=how-it-works-and-why-value-or-pointer-receiver-matters>How it Works and Why Value or Pointer Receiver Matters</h2><p>I found an interesting code on <a href=https://stackoverflow.com/questions/28893586/golang-defer-clarification>Stack Overflow</a>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>X</span> <span style=color:#66d9ef>struct</span> {
    <span style=color:#a6e22e>S</span> <span style=color:#66d9ef>string</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>x</span> <span style=color:#a6e22e>X</span>) <span style=color:#a6e22e>Close</span>() {
    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Value-Closing&#34;</span>, <span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>S</span>)
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>x</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>X</span>) <span style=color:#a6e22e>CloseP</span>() {
    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Pointer-Closing&#34;</span>, <span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>S</span>)
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#a6e22e>x</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>X</span>{<span style=color:#e6db74>&#34;Value-X First&#34;</span>}
    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>Close</span>()
    <span style=color:#a6e22e>x</span> = <span style=color:#a6e22e>X</span>{<span style=color:#e6db74>&#34;Value-X Second&#34;</span>}
    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>Close</span>()

    <span style=color:#a6e22e>x2</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>X</span>{<span style=color:#e6db74>&#34;Value-X2 First&#34;</span>}
    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>x2</span>.<span style=color:#a6e22e>CloseP</span>()
    <span style=color:#a6e22e>x2</span> = <span style=color:#a6e22e>X</span>{<span style=color:#e6db74>&#34;Value-X2 Second&#34;</span>}
    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>x2</span>.<span style=color:#a6e22e>CloseP</span>()

    <span style=color:#a6e22e>xp</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>X</span>{<span style=color:#e6db74>&#34;Pointer-X First&#34;</span>}
    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>xp</span>.<span style=color:#a6e22e>Close</span>()
    <span style=color:#a6e22e>xp</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>X</span>{<span style=color:#e6db74>&#34;Pointer-X Second&#34;</span>}
    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>xp</span>.<span style=color:#a6e22e>Close</span>()

    <span style=color:#a6e22e>xp2</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>X</span>{<span style=color:#e6db74>&#34;Pointer-X2 First&#34;</span>}
    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>xp2</span>.<span style=color:#a6e22e>CloseP</span>()
    <span style=color:#a6e22e>xp2</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>X</span>{<span style=color:#e6db74>&#34;Pointer-X2 Second&#34;</span>}
    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>xp2</span>.<span style=color:#a6e22e>CloseP</span>()
}
</code></pre></div><p>The output is:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>Pointer-Closing Pointer-X2 Second
Pointer-Closing Pointer-X2 First
Value-Closing Pointer-X Second
Value-Closing Pointer-X First
Pointer-Closing Value-X2 Second
Pointer-Closing Value-X2 Second
Value-Closing Value-X Second
Value-Closing Value-X First</code></pre></td></tr></table></div></div><p>Take a look at line 5-6, why <code>Pointer-Closing Value-X2 Second</code> was printed twice? According to <a href=https://golang.org/doc/effective%5Fgo.html#defer>Effective Go</a>, &ldquo;<strong>The arguments to the deferred function (which include the receiver if the function is a method) are evaluated when the defer executes, not when the call executes.</strong>". And the function&rsquo;s parameters will <strong>saved anew</strong> when evaluated.</p><p>As <code>x2</code> is value and the defer function <code>CloseP</code>'s receiver is a pointer, once <code>defer</code> executes, it will create a pointer which points to <code>x2</code> as function&rsquo;s caller. In the following defer, it will create a pointer which point to <code>x2</code> again. Although <code>x2.S</code> change to &ldquo;Second&rdquo;, <code>x2</code>'s address never changes. Finally, when these two defer is called, the same log was printed again.</p><h2 id=how-to-exit-program-and-run-all-defer>How to Exit Program and Run all Defer</h2><p>From <a href=https://golang.org/pkg/runtime/#Goexit>Golang Runtime</a>:</p><blockquote><p><code>runtime.Goexit()</code> terminates the goroutine that calls it. No other goroutine is affected. Goexit runs all deferred calls before terminating the goroutine. Because Goexit is not a panic, any recover calls in those deferred functions will return nil.</p><p>Calling Goexit from the main goroutine terminates that goroutine without func main returning. Since func main has not returned, the program continues execution of other goroutines. If all other goroutines exit, the program crashes.</p></blockquote><p>If you want the program to exit normally, just add <code>defer os.Exit(0)</code> at the top of <code>main</code> function. Here is the example code:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
  <span style=color:#e6db74>&#34;fmt&#34;</span>
  <span style=color:#e6db74>&#34;os&#34;</span>
  <span style=color:#e6db74>&#34;runtime&#34;</span>
  <span style=color:#e6db74>&#34;time&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>subGoroutine</span>() {
  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;exit sub routine&#34;</span>)
  <span style=color:#66d9ef>for</span> {
    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;sub goroutine running&#34;</span>)
    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
  }
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>0</span>)
  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;calling os.Exit&#34;</span>)

  <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>subGoroutine</span>()

  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
  <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Goexit</span>()
}
</code></pre></div><p>Output:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>sub goroutine running
sub goroutine running
sub goroutine running
calling os.Exit

Process finished with exit code 0
</code></pre></div><p>The defer code in main goroutine are executed, but those in <code>subGoroutine</code> will not be executed. As <code>os.Exit</code> will</p><blockquote><p>Exit causes the current program to exit with the given status code. Conventionally, code zero indicates success, non-zero an error. The program terminates immediately; deferred functions are not run.</p><p>from <a href=https://golang.org/pkg/os/#Exit>godoc</a></p></blockquote><h2 id=ref>Ref:</h2><ol><li><a href=https://draveness.me/golang/keyword/golang-defer.html>面向信仰编程 defer</a></li><li><a href=https://stackoverflow.com/questions/28893586/golang-defer-clarification>Golang defer clarification</a></li><li><a href=https://stackoverflow.com/questions/27629380/how-to-exit-a-go-program-honoring-deferred-calls/39755730>How to exit a go program honoring deferred calls?</a></li><li><a href=https://golang.org/doc/effective%5Fgo.html#defer>Effective Go</a></li><li><a href=https://golang.org/pkg/runtime/#Goexit>Golang Runtime</a></li><li><a href=https://tachingchen.com/tw/blog/go-defer-and-os-exit/>Go defer 遇上 os.Exit 時失效</a></li></ol></div><footer><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"kkblog-1"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js id=MathJax-script></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};</script></section></div><footer class=footer><section class=container>©
2021
KK
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=https://www.fromkk.com/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-153788833-1','auto');ga('send','pageview');}</script></body></html>