<!doctype html><html lang=en><head><title>Difference between Value and Pointer variable in Defer in Go · KK's Blog (fromkk)
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="KK"><meta name=description content="defer is a useful function to do cleanup, as it will execute in LIFO order before the surrounding function returns. If you don&rsquo;t know how it works, sometimes the execution result may confuse you.
How it Works and Why Value or Pointer Receiver Matters Link to heading I found an interesting code on Stack Overflow:
type X struct { S string } func (x X) Close() { fmt.Println(&#34;Value-Closing&#34;, x.S) } func (x *X) CloseP() { fmt."><meta name=keywords content="fromkk,blog,kk blog,developer,personal,python,golang,go,linux,machine learning"><meta name=twitter:card content="summary"><meta name=twitter:title content="Difference between Value and Pointer variable in Defer in Go"><meta name=twitter:description content="defer is a useful function to do cleanup, as it will execute in LIFO order before the surrounding function returns. If you don&rsquo;t know how it works, sometimes the execution result may confuse you.
How it Works and Why Value or Pointer Receiver Matters Link to heading I found an interesting code on Stack Overflow:
type X struct { S string } func (x X) Close() { fmt.Println(&#34;Value-Closing&#34;, x.S) } func (x *X) CloseP() { fmt."><meta property="og:title" content="Difference between Value and Pointer variable in Defer in Go"><meta property="og:description" content="defer is a useful function to do cleanup, as it will execute in LIFO order before the surrounding function returns. If you don&rsquo;t know how it works, sometimes the execution result may confuse you.
How it Works and Why Value or Pointer Receiver Matters Link to heading I found an interesting code on Stack Overflow:
type X struct { S string } func (x X) Close() { fmt.Println(&#34;Value-Closing&#34;, x.S) } func (x *X) CloseP() { fmt."><meta property="og:type" content="article"><meta property="og:url" content="https://www.fromkk.com/posts/difference-between-value-and-pointer-variable-in-defer-in-go/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-12-19T22:33:00+08:00"><meta property="article:modified_time" content="2020-08-01T00:39:56+08:00"><link rel=canonical href=https://www.fromkk.com/posts/difference-between-value-and-pointer-variable-in-defer-in-go/><link rel=preload href="https://www.fromkk.com/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://www.fromkk.com/css/coder.min.ea4c355c5f9913809f506132a80bf3fab84f2679dee370f334f7385a36d24c38.css integrity="sha256-6kw1XF+ZE4CfUGEyqAvz+rhPJnne43DzNPc4WjbSTDg=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://www.fromkk.com/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=https://www.fromkk.com/images/favicon.svg sizes=any><link rel=icon type=image/png href=https://www.fromkk.com/icons/icon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://www.fromkk.com/icons/icon-16x16.png sizes=16x16><link rel=apple-touch-icon href=https://www.fromkk.com/icons/icon-192x192.png><link rel=apple-touch-icon sizes=180x180 href=https://www.fromkk.com/icons/icon-192x192.png><link rel=manifest href=https://www.fromkk.com/site.webmanifest><link rel=mask-icon href=https://www.fromkk.com/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://www.fromkk.com/>KK's Blog (fromkk)
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/posts/index.xml>RSS</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://www.fromkk.com/posts/difference-between-value-and-pointer-variable-in-defer-in-go/>Difference between Value and Pointer variable in Defer in Go</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2019-12-19T22:33:00+08:00>12/19/2019
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
3-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=https://www.fromkk.com/tags/go/>Go</a>
</span><span class=separator>•</span>
<span class=tag><a href=https://www.fromkk.com/tags/defer/>Defer</a></span></div></div></header><div class=post-content><p><code>defer</code> is a useful function to do cleanup, as it will execute in LIFO order before the surrounding function returns. If you don&rsquo;t know how it works, sometimes the execution result may confuse you.</p><h2 id=how-it-works-and-why-value-or-pointer-receiver-matters>How it Works and Why Value or Pointer Receiver Matters
<a class=heading-link href=#how-it-works-and-why-value-or-pointer-receiver-matters><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>I found an interesting code on <a href=https://stackoverflow.com/questions/28893586/golang-defer-clarification class=external-link target=_blank rel=noopener>Stack Overflow</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>X</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>S</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>x</span> <span style=color:#a6e22e>X</span>) <span style=color:#a6e22e>Close</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Value-Closing&#34;</span>, <span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>S</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>x</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>X</span>) <span style=color:#a6e22e>CloseP</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Pointer-Closing&#34;</span>, <span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>S</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>x</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>X</span>{<span style=color:#e6db74>&#34;Value-X First&#34;</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>x</span> = <span style=color:#a6e22e>X</span>{<span style=color:#e6db74>&#34;Value-X Second&#34;</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>x2</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>X</span>{<span style=color:#e6db74>&#34;Value-X2 First&#34;</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>x2</span>.<span style=color:#a6e22e>CloseP</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>x2</span> = <span style=color:#a6e22e>X</span>{<span style=color:#e6db74>&#34;Value-X2 Second&#34;</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>x2</span>.<span style=color:#a6e22e>CloseP</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xp</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>X</span>{<span style=color:#e6db74>&#34;Pointer-X First&#34;</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>xp</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xp</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>X</span>{<span style=color:#e6db74>&#34;Pointer-X Second&#34;</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>xp</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xp2</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>X</span>{<span style=color:#e6db74>&#34;Pointer-X2 First&#34;</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>xp2</span>.<span style=color:#a6e22e>CloseP</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xp2</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>X</span>{<span style=color:#e6db74>&#34;Pointer-X2 Second&#34;</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>xp2</span>.<span style=color:#a6e22e>CloseP</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The output is:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Pointer-Closing Pointer-X2 Second
</span></span><span style=display:flex><span>Pointer-Closing Pointer-X2 First
</span></span><span style=display:flex><span>Value-Closing Pointer-X Second
</span></span><span style=display:flex><span>Value-Closing Pointer-X First
</span></span><span style=display:flex><span>Pointer-Closing Value-X2 Second
</span></span><span style=display:flex><span>Pointer-Closing Value-X2 Second
</span></span><span style=display:flex><span>Value-Closing Value-X Second
</span></span><span style=display:flex><span>Value-Closing Value-X First</span></span></code></pre></td></tr></table></div></div><p>Take a look at line 5-6, why <code>Pointer-Closing Value-X2 Second</code> was printed twice? According to <a href=https://golang.org/doc/effective%5Fgo.html#defer class=external-link target=_blank rel=noopener>Effective Go</a>, &ldquo;<strong>The arguments to the deferred function (which include the receiver if the function is a method) are evaluated when the defer executes, not when the call executes.</strong>&rdquo;. And the function&rsquo;s parameters will <strong>saved anew</strong> when evaluated.</p><p>As <code>x2</code> is value and the defer function <code>CloseP</code>&rsquo;s receiver is a pointer, once <code>defer</code> executes, it will create a pointer which points to <code>x2</code> as function&rsquo;s caller. In the following defer, it will create a pointer which point to <code>x2</code> again. Although <code>x2.S</code> change to &ldquo;Second&rdquo;, <code>x2</code>&rsquo;s address never changes. Finally, when these two defer is called, the same log was printed again.</p><h2 id=how-to-exit-program-and-run-all-defer>How to Exit Program and Run all Defer
<a class=heading-link href=#how-to-exit-program-and-run-all-defer><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>From <a href=https://golang.org/pkg/runtime/#Goexit class=external-link target=_blank rel=noopener>Golang Runtime</a>:</p><blockquote><p><code>runtime.Goexit()</code> terminates the goroutine that calls it. No other goroutine is affected. Goexit runs all deferred calls before terminating the goroutine. Because Goexit is not a panic, any recover calls in those deferred functions will return nil.</p><p>Calling Goexit from the main goroutine terminates that goroutine without func main returning. Since func main has not returned, the program continues execution of other goroutines. If all other goroutines exit, the program crashes.</p></blockquote><p>If you want the program to exit normally, just add <code>defer os.Exit(0)</code> at the top of <code>main</code> function. Here is the example code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;runtime&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>subGoroutine</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;exit sub routine&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;sub goroutine running&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;calling os.Exit&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>subGoroutine</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Goexit</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>sub goroutine running
</span></span><span style=display:flex><span>sub goroutine running
</span></span><span style=display:flex><span>sub goroutine running
</span></span><span style=display:flex><span>calling os.Exit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Process finished with exit code 0
</span></span></code></pre></div><p>The defer code in main goroutine are executed, but those in <code>subGoroutine</code> will not be executed. As <code>os.Exit</code> will</p><blockquote><p>Exit causes the current program to exit with the given status code. Conventionally, code zero indicates success, non-zero an error. The program terminates immediately; deferred functions are not run.</p><p>from <a href=https://golang.org/pkg/os/#Exit class=external-link target=_blank rel=noopener>godoc</a></p></blockquote><h2 id=ref>Ref:
<a class=heading-link href=#ref><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ol><li><a href=https://draveness.me/golang/keyword/golang-defer.html class=external-link target=_blank rel=noopener>面向信仰编程 defer</a></li><li><a href=https://stackoverflow.com/questions/28893586/golang-defer-clarification class=external-link target=_blank rel=noopener>Golang defer clarification</a></li><li><a href=https://stackoverflow.com/questions/27629380/how-to-exit-a-go-program-honoring-deferred-calls/39755730 class=external-link target=_blank rel=noopener>How to exit a go program honoring deferred calls?</a></li><li><a href=https://golang.org/doc/effective%5Fgo.html#defer class=external-link target=_blank rel=noopener>Effective Go</a></li><li><a href=https://golang.org/pkg/runtime/#Goexit class=external-link target=_blank rel=noopener>Golang Runtime</a></li><li><a href=https://tachingchen.com/tw/blog/go-defer-and-os-exit/ class=external-link target=_blank rel=noopener>Go defer 遇上 os.Exit 時失效</a></li></ol></div><footer><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme"),themeInParams="preferred-color-scheme";getTheme==null&&(themeInParams!==""&&themeInParams!=="auto"?getTheme=themeInParams:getTheme=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","bebound/bebound.github.io"),s.setAttribute("issue-term","pathname"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container>©
2023
KK
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=https://www.fromkk.com/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-153788833-1","auto"),ga("send","pageview"))</script></body></html>