<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=content-language content="en">
<meta name=color-scheme content="light dark">
<meta name=author content="KK">
<meta name=description content="Thanks for the articles I list at the end of this post, I understand how transformers works. These posts are comprehensive, but there are some points that confused me.
First, this is the graph that was referenced by almost all of the post related to Transformer.
 Transformer consists of these parts: Input, Encoder*N, Output Input, Decoder*N, Output. I&rsquo;ll explain them step by step.
Input    The input word will map to 512 dimension vector.">
<meta name=keywords content="fromkk,blog,kk blog,developer,personal,python,golang,go,linux,machine learning">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="The Annotated The Annotated Transformer">
<meta name=twitter:description content="Thanks for the articles I list at the end of this post, I understand how transformers works. These posts are comprehensive, but there are some points that confused me.
First, this is the graph that was referenced by almost all of the post related to Transformer.
 Transformer consists of these parts: Input, Encoder*N, Output Input, Decoder*N, Output. I&rsquo;ll explain them step by step.
Input    The input word will map to 512 dimension vector.">
<meta property="og:title" content="The Annotated The Annotated Transformer">
<meta property="og:description" content="Thanks for the articles I list at the end of this post, I understand how transformers works. These posts are comprehensive, but there are some points that confused me.
First, this is the graph that was referenced by almost all of the post related to Transformer.
 Transformer consists of these parts: Input, Encoder*N, Output Input, Decoder*N, Output. I&rsquo;ll explain them step by step.
Input    The input word will map to 512 dimension vector.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.fromkk.com/posts/the-annotated-the-annotated-transformer/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2019-09-01T16:00:00+08:00">
<meta property="article:modified_time" content="2021-05-10T21:19:26+08:00">
<title>
The Annotated The Annotated Transformer · KK's Blog (fromkk)
</title>
<link rel=canonical href=https://www.fromkk.com/posts/the-annotated-the-annotated-transformer/>
<link rel=preload href="https://www.fromkk.com/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin>
<link rel=stylesheet href=https://www.fromkk.com/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css integrity="sha256-2f3b/+byfmmYXcX+BHHNsOV/v0d1cUvD2Eesywj0ofY=" crossorigin=anonymous media=screen>
<link rel=stylesheet href=https://www.fromkk.com/css/coder-dark.min.002ee2378e14c7a68f1f0a53d9694ed252090987c4e768023fac694a4fc5f793.css integrity="sha256-AC7iN44Ux6aPHwpT2WlO0lIJCYfE52gCP6xpSk/F95M=" crossorigin=anonymous media=screen>
<link rel=icon type=image/png href=https://www.fromkk.com/icons/icon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=https://www.fromkk.com/icons/icon-16x16.png sizes=16x16>
<link rel=apple-touch-icon href=https://www.fromkk.com/icons/icon-192x192.png>
<link rel=apple-touch-icon sizes=180x180 href=https://www.fromkk.com/icons/icon-192x192.png>
<meta name=generator content="Hugo 0.92.0">
</head>
<body class="preload-transitions colorscheme-auto">
<div class=float-container>
<a id=dark-mode-toggle class=colorscheme-toggle>
<i class="fa fa-adjust fa-fw" aria-hidden=true></i>
</a>
</div>
<main class=wrapper>
<nav class=navigation>
<section class=container>
<a class=navigation-title href=https://www.fromkk.com/>
KK's Blog (fromkk)
</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle>
<i class="fa fa-bars fa-fw" aria-hidden=true></i>
</label>
<ul class=navigation-list>
<li class=navigation-item>
<a class=navigation-link href=https://www.fromkk.com/posts/>Blog</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=https://www.fromkk.com/tags/>Tags</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=https://www.fromkk.com/about/>About</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=https://www.fromkk.com/posts/index.xml>RSS</a>
</li>
</ul>
</section>
</nav>
<div class=content>
<section class="container post">
<article>
<header>
<div class=post-title>
<h1 class=title>
<a class=title-link href=https://www.fromkk.com/posts/the-annotated-the-annotated-transformer/>
The Annotated The Annotated Transformer
</a>
</h1>
</div>
<div class=post-meta>
<div class=date>
<span class=posted-on>
<i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2019-09-01T16:00:00+08:00>
09/01/2019
</time>
</span>
<span class=reading-time>
<i class="fa fa-clock-o" aria-hidden=true></i>
4-minute read
</span>
</div>
<div class=tags>
<i class="fa fa-tag" aria-hidden=true></i>
<span class=tag>
<a href=https://www.fromkk.com/tags/machine-learning/>Machine Learning</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=https://www.fromkk.com/tags/transformer/>Transformer</a>
</span></div>
</div>
</header>
<div>
<p>Thanks for the articles I list at the end of this post, I understand how transformers works. These posts are comprehensive, but there are some points that confused me.</p>
<p>First, this is the graph that was referenced by almost all of the post related to Transformer.</p>
<figure><img src=https://www.fromkk.com/images/transformer_main.png width=400>
</figure>
<p>Transformer consists of these parts: Input, Encoder*N, Output Input, Decoder*N, Output. I&rsquo;ll explain them step by step.</p>
<h2 id=input>
Input
<a class=heading-link href=#input>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>The input word will map to 512 dimension vector. Then generate Positional Encoding(PE) and add it to the original embeddings.</p>
<h3 id=positional-encoding>
Positional Encoding
<a class=heading-link href=#positional-encoding>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>The transformer model does not contains recurrence and convolution. In order to let the model capture the sequence of input word, it add PE into embeddings.</p>
<figure><img src=https://www.fromkk.com/images/transformer_add_pe.png width=500>
</figure>
<p>PE will generate a 512 dimension vector for each position:</p>
<p>\[\begin{align*}
PE_{(pos,2i)} = sin(pos / 10000^{2i/d_{model}}) \\\
PE_{(pos,2i+1)} = cos(pos / 10000^{2i/d_{model}})
\end{align*}\]
The even and odd dimension use <code>sin</code> and <code>cos</code> function respectively.</p>
<p>For example, the second word&rsquo;s PE should be: \(sin(2 / 10000^{0 / 512}), cos(2 / 10000^{0 / 512}), sin(2 / 10000^{2 / 512}), cos(2 / 10000^{2 / 512})\text{&mldr;}\)</p>
<p>The value range of PE is <code>(-1,1)</code>, and each position&rsquo;s PE is slight different, as <code>cos</code> and <code>sin</code> has different frequency. Also, for any fixed offset k, \(PE_{pos+k}\) can be represented as a linear function of \(PE_{pos}\).</p>
<p>For even dimension, let \(10000^{2i/d_{model}}\) be \(\alpha\), for even dimension:</p>
<p>\[\begin{aligned}
PE_{pos+k}&=sin((pos+k)/\alpha) \\\
&=sin(pos/\alpha)cos(k/\alpha)+cos(pos/\alpha)sin(k/\alpha)\\\
&=PE_{pos\_even}K_1+PE_{pos\_odd}K_2
\end{aligned}\]</p>
<figure><img src=https://www.fromkk.com/images/transformer_pe1.png width=500>
</figure>
<p>The PE implementation in <a href=https://github.com/tensorflow/tensor2tensor/blob/5bfe69a7d68b7d61d51fac36c6088f94b9d6fdc6/tensor2tensor/layers/common%5Fattention.py#L457>tensor2tensor</a> use <code>sin</code> in first half of dimension and <code>cos</code> in the rest part of dimension.</p>
<figure><img src=https://www.fromkk.com/images/transformer_pe2.png width=500>
</figure>
<h2 id=encoder>
Encoder
<a class=heading-link href=#encoder>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>There are 6 Encoder layer in Transformer, each layer consists of two sub-layer: Multi-Head Attention and Feed Forward Neural Network.</p>
<h3 id=multi-head-attention>
Multi-Head Attention
<a class=heading-link href=#multi-head-attention>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>Let&rsquo;s begin with single head attention. In short, it maps word embeddings to <code>q</code> <code>k</code> <code>v</code> and use <code>q</code> <code>k</code> <code>v</code> vector to calculate the attention.</p>
<p>The input words map to <code>q</code> <code>k</code> <code>v</code> by multiply the Query, Keys Values matrix. Then for the given Query, the attention for each word in sentence will be calculated by this formula: \(\mathrm{attention}=\mathrm{softmax}(\frac{qk^T}{\sqrt{d_k}})v\), where <code>q</code> <code>k</code> <code>v</code> is a 64 dimension vector.</p>
<figure><img src=https://www.fromkk.com/images/transformer_self_attention.png width=500>
</figure>
<p>Matrix view:</p>
<p>\(Attention(Q, K, V) = \mathrm{softmax}(\frac{(XW^Q)(XW^K)^T}{\sqrt{d_k}})(XW^V)\) where \(X\) is the input embedding.</p>
<p>The single head attention only output a 64 dimension vector, but the input dimension is 512. How to transform back to 512? That&rsquo;s why transformer has multi-head attention.</p>
<p>Each head has its own \(W^Q\) \(W^K\) \(W^V\) matrix, and produces \(Z_0,Z_1&mldr;Z_7\),(\(Z_0\)&rsquo;s shape is <code>(512, 64)</code>) the concat the outputted vectors as \(O\). \(O\) will multiply a weight matrix \(W^O\) (\(W^O\)&rsquo;s shape is <code>(512, 512)</code>) and the result is \(Z\), which will be sent to Feed Forward Network.</p>
<figure><img src=https://www.fromkk.com/images/transformer_multihead.png width=500>
</figure>
<p>Multi-head attention allows the model to jointly attend to information from different representation subspaces at different positions.</p>
<p>The whole procedure looks like this:</p>
<figure><img src=https://www.fromkk.com/images/transformer_multihead_all.png width=500>
</figure>
<h3 id=add-and-norm>
Add & Norm
<a class=heading-link href=#add-and-norm>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>This layer works like this line of code: <code>norm(x+dropout(sublayer(x)))</code> or <code>x+dropout(sublayer(norm(x)))</code>. The sublayer is Multi-Head Attention or FF Network.</p>
<h4 id=layer-normalization>
Layer Normalization
<a class=heading-link href=#layer-normalization>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h4>
<p>Layer Norm is similar to Batch Normalization, but it tries to normalize the whole layer&rsquo;s features rather than each feature.(<strong>Scale</strong> and <strong>Shift</strong> also apply for each feature) More details can be found in this <a href=https://arxiv.org/abs/1607.06450>paper</a>.</p>
<figure><img src=https://www.fromkk.com/images/transformer_layer_norm.png width=500>
</figure>
<h3 id=position-wise-feed-forward-network>
Position-wise Feed Forward Network
<a class=heading-link href=#position-wise-feed-forward-network>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>This layer is a Neural Network whose size is <code>(512, 2048, 512)</code>. The exact same feed-forward network is independently applied to each position.</p>
<figure><img src=https://www.fromkk.com/images/transformer_encoder.png width=500>
</figure>
<h2 id=output-input>
Output Input
<a class=heading-link href=#output-input>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>Same as Input.</p>
<h2 id=decoder>
Decoder
<a class=heading-link href=#decoder>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>The decoder is pretty similar to Encoder. It also has 6 layers, but has 3 sublayers in each Decoder. It add a masked multi-head-attention at the beginning of Decoder.</p>
<h3 id=masked-multi-head-attention>
Masked Multi-Head Attention
<a class=heading-link href=#masked-multi-head-attention>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>This layer is used to block future words during training. For example, if the output is <code>&lt;bos> hello world &lt;eos></code>. First, we should use <code>&lt;bos></code> as input to predict <code>hello</code>, <code>hello world &lt;eos></code> will be masked to 0.</p>
<h3 id=key-and-value-in-decoder-multi-head-attention-layer>
Key and Value in Decoder Multi-Head Attention Layer
<a class=heading-link href=#key-and-value-in-decoder-multi-head-attention-layer>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>In Encoder, the <code>q</code> <code>k</code> <code>v</code> vector is generated by \(XW^Q\), \(XW^K\) and \(XW^V\). In the second sub-layer of Decoder, <code>q</code> <code>k</code> <code>v</code> was generated by \(XW^Q\), \(YW^K\) and \(YW^V\), where \(Y\) is the Encoder&rsquo;s output, \(X\) is the <code>&lt;init of sentence></code> or previous output.</p>
<p>The animation below illustrates how to apply the Transformer to machine translation.</p>
<figure><img src=https://www.fromkk.com/images/transformer_translate.gif width=500>
</figure>
<h2 id=output>
Output
<a class=heading-link href=#output>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>Using a linear layer to predict the output.</p>
<h2 id=ref>
Ref:
<a class=heading-link href=#ref>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<ol>
<li><a href=http://nlp.seas.harvard.edu/2018/04/03/attention.html>The Annotated Transformer</a></li>
<li><a href=http://jalammar.github.io/illustrated-transformer/>The Illustrated Transformer</a></li>
<li><a href=https://mchromiak.github.io/articles/2017/Sep/12/Transformer-Attention-is-all-you-need/#.XMb3ZC97FPs>The Transformer – Attention is all you need</a></li>
<li><a href=https://medium.com/@bgg/seq2seq-pay-attention-to-self-attention-part-2-cf81bf32c73d>Seq2seq pay Attention to Self Attention: Part 2</a></li>
<li><a href=https://juejin.im/post/5b9f1af0e51d450e425eb32d>Transformer模型的PyTorch实现</a></li>
<li><a href=https://towardsdatascience.com/how-to-code-the-transformer-in-pytorch-24db27c8f9ec>How to code The Transformer in Pytorch</a></li>
<li><a href=https://towardsdatascience.com/deconstructing-bert-part-2-visualizing-the-inner-workings-of-attention-60a16d86b5c1>Deconstructing BERT, Part 2: Visualizing the Inner Workings of Attention</a></li>
<li><a href=https://ai.googleblog.com/2017/08/transformer-novel-neural-network.html>Transformer: A Novel Neural Network Architecture for Language Understanding</a></li>
<li><a href=https://d2l.ai/chapter%5Fattention-mechanisms/transformer.html>Dive into Deep Learning - 10.3 Transformer</a></li>
<li><a href=https://zhuanlan.zhihu.com/p/80986272>10分钟带你深入理解Transformer原理及实现</a></li>
</ol>
</div>
<footer>
<script src=https://utteranc.es/client.js repo=bebound/bebound.github.io issue-term=pathname label=comment theme=preferred-color-scheme crossorigin=anonymous async></script>
</footer>
</article>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload="renderMathInElement(document.body,{delimiters:[{left:'$$',right:'$$',display:!0},{left:'$',right:'$',display:!1},{left:'\\(',right:'\\)',display:!1},{left:'\\[',right:'\\]',display:!0}]})"></script>
</section>
</div>
<footer class=footer>
<section class=container>
©
2022
KK
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.
</section>
</footer>
</main>
<script src=https://www.fromkk.com/js/coder.min.03b17769f4f91ae35667e1f2a1ca8c16f50562576cf90ff32b3179926914daa5.js integrity="sha256-A7F3afT5GuNWZ+HyocqMFvUFYlds+Q/zKzF5kmkU2qU="></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-153788833-1','auto'),ga('send','pageview'))</script>
</body>
</html>