<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=author content="KK"><meta name=description content="Thanks for the articles I list at the end of this post, I understand how transformers works. These posts are comprehensive, but there are some points that confused me.
First, this is the graph that was referenced by almost all of the post related to Transformer.
  Transformer consists of these parts: Input, Encoder*N, Output Input, Decoder*N, Output. I&rsquo;ll explain them step by step.
Input The input word will map to 512 dimension vector."><meta name=keywords content="fromkk,blog,kk blog,developer,personal,python,golang,go,linux,machine learning"><meta name=twitter:card content="summary"><meta name=twitter:title content="The Annotated The Annotated Transformer"><meta name=twitter:description content="Thanks for the articles I list at the end of this post, I understand how transformers works. These posts are comprehensive, but there are some points that confused me.
First, this is the graph that was referenced by almost all of the post related to Transformer.
  Transformer consists of these parts: Input, Encoder*N, Output Input, Decoder*N, Output. I&rsquo;ll explain them step by step.
Input The input word will map to 512 dimension vector."><meta property="og:title" content="The Annotated The Annotated Transformer"><meta property="og:description" content="Thanks for the articles I list at the end of this post, I understand how transformers works. These posts are comprehensive, but there are some points that confused me.
First, this is the graph that was referenced by almost all of the post related to Transformer.
  Transformer consists of these parts: Input, Encoder*N, Output Input, Decoder*N, Output. I&rsquo;ll explain them step by step.
Input The input word will map to 512 dimension vector."><meta property="og:type" content="article"><meta property="og:url" content="https://www.fromkk.com/posts/the-annotated-the-annotated-transformer/"><meta property="article:published_time" content="2019-09-01T16:00:00+08:00"><meta property="article:modified_time" content="2020-02-29T14:47:38+08:00"><base href=https://www.fromkk.com/posts/the-annotated-the-annotated-transformer/><title>The Annotated The Annotated Transformer · KK's Blog (fromkk)</title><link rel=canonical href=https://www.fromkk.com/posts/the-annotated-the-annotated-transformer/><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.13.0/css/all.css integrity=sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://www.fromkk.com/css/coder.min.a4f332213a21ce8eb521670c614470c58923aaaf385e2a73982c31dd7642decb.css integrity="sha256-pPMyITohzo61IWcMYURwxYkjqq84XipzmCwx3XZC3ss=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://www.fromkk.com/css/custom.css><link rel=icon type=image/png href=https://www.fromkk.com/icons/icon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://www.fromkk.com/icons/icon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.68.3"></head><body class=colorscheme-light><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://www.fromkk.com/>KK's Blog (fromkk)</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fas fa-bars"></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://www.fromkk.com/posts/index.xml>RSS</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>The Annotated The Annotated Transformer</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i><time datetime=2019-09-01T16:00:00+08:00>09/01/2019</time></span>
<span class=reading-time><i class="fas fa-clock"></i>4-minute read</span></div><div class=tags><i class="fas fa-tag"></i><a href=https://www.fromkk.com/tags/machine-learning/>Machine Learning</a>
<span class=separator>•</span>
<a href=https://www.fromkk.com/tags/transformer/>Transformer</a></div></div></header><div><p>Thanks for the articles I list at the end of this post, I understand how transformers works. These posts are comprehensive, but there are some points that confused me.</p><p>First, this is the graph that was referenced by almost all of the post related to Transformer.</p><figure><img src=https://www.fromkk.com/images/transformer_main.png width=400></figure><p>Transformer consists of these parts: Input, Encoder*N, Output Input, Decoder*N, Output. I&rsquo;ll explain them step by step.</p><h2 id=input>Input</h2><p>The input word will map to 512 dimension vector. Then generate Positional Encoding(PE) and add it to the original embeddings.</p><h3 id=positional-encoding>Positional Encoding</h3><p>The transformer model does not contains recurrence and convolution. In order to let the model capture the sequence of input word, it add PE into embeddings.</p><figure><img src=https://www.fromkk.com/images/transformer_add_pe.png width=500></figure><p>PE will generate a 512 dimension vector for each position:</p><p>\[\begin{align*}
PE_{(pos,2i)} = sin(pos / 10000^{2i/d_{model}}) \\\<br>PE_{(pos,2i+1)} = cos(pos / 10000^{2i/d_{model}})
\end{align*}\]
The even and odd dimension use <code>sin</code> and <code>cos</code> function respectively.</p><p>For example, the second word&rsquo;s PE should be: \(sin(2 / 10000^{0 / 512}), cos(2 / 10000^{0 / 512}), sin(2 / 10000^{2 / 512}), cos(2 / 10000^{2 / 512})\text{&mldr;}\)</p><p>The value range of PE is <code>(-1,1)</code>, and each position&rsquo;s PE is slight different, as <code>cos</code> and <code>sin</code> has different frequency. Also, for any fixed offset k, \(PE_{pos+k}\) can be represented as a linear function of \(PE_{pos}\).</p><p>For even dimension, let \(10000^{2i/d_{model}}\) be \(\alpha\), for even dimension:</p><p>\[\begin{aligned}
PE_{pos+k}&=sin((pos+k)/\alpha) \\\<br>&=sin(pos/\alpha)cos(k/\alpha)+cos(pos/\alpha)sin(k/\alpha)\\\<br>&=PE_{pos\_even}K_1+PE_{pos\_odd}K_2
\end{aligned}\]</p><figure><img src=https://www.fromkk.com/images/transformer_pe1.png width=500></figure><p>The PE implementation in <a href=https://github.com/tensorflow/tensor2tensor/blob/5bfe69a7d68b7d61d51fac36c6088f94b9d6fdc6/tensor2tensor/layers/common%5Fattention.py#L457>tensor2tensor</a> use <code>sin</code> in first half of dimension and <code>cos</code> in the rest part of dimension.</p><figure><img src=https://www.fromkk.com/images/transformer_pe2.png width=500></figure><h2 id=encoder>Encoder</h2><p>There are 6 Encoder layer in Transformer, each layer consists of two sub-layer: Multi-Head Attention and Feed Forward Neural Network.</p><h3 id=multi-head-attention>Multi-Head Attention</h3><p>Let&rsquo;s begin with single head attention. In short, it maps word embeddings to <code>q</code> <code>k</code> <code>v</code> and use <code>q</code> <code>k</code> <code>v</code> vector to calculate the attention.</p><p>The input words map to <code>q</code> <code>k</code> <code>v</code> by multiply the Query, Keys Values matrix. Then for the given Query, the attention for each word in sentence will be calculated by this formula: \(\mathrm{attention}=\mathrm{softmax}(\frac{qk^T}{\sqrt{d_k}})v\), where <code>q</code> <code>k</code> <code>v</code> is a 64 dimension vector.</p><figure><img src=https://www.fromkk.com/images/transformer_self_attention.png width=500></figure><p>Matrix view:</p><p>\(Attention(Q, K, V) = \mathrm{softmax}(\frac{(XW^Q)(XW^K)^T}{\sqrt{d_k}})(XW^V)\) where \(X\) is the input embedding.</p><p>The single head attention only output a 64 dimension vector, but the input dimension is 512. How to transform back to 512? That&rsquo;s why transformer has multi-head attention.</p><p>Each head has its own \(W^Q\) \(W^K\) \(W^V\) matrix, and produces \(Z_0,Z_1&mldr;Z_7\),(\(Z_0\)&lsquo;s shape is <code>(512, 64)</code>) the concat the outputted vectors as \(O\). \(O\) will multiply a weight matrix \(W^O\) (\(W^O\)&lsquo;s shape is <code>(512, 512)</code>) and the result is \(Z\), which will be sent to Feed Forward Network.</p><figure><img src=https://www.fromkk.com/images/transformer_multihead.png width=500></figure><p>Multi-head attention allows the model to jointly attend to information from different representation subspaces at different positions.</p><p>The whole procedure looks like this:</p><figure><img src=https://www.fromkk.com/images/transformer_multihead_all.png width=500></figure><h3 id=add-and-norm>Add & Norm</h3><p>This layer works like this line of code: <code>norm(x+dropout(sublayer(x)))</code> or <code>x+dropout(sublayer(norm(x)))</code>. The sublayer is Multi-Head Attention or FF Network.</p><h4 id=layer-normalization>Layer Normalization</h4><p>Layer Norm is similar to Batch Normalization, but it tries to normalize the whole layer&rsquo;s features rather than each feature.(<strong>Scale</strong> and <strong>Shift</strong> also apply for each feature) More details can be found in this <a href=https://arxiv.org/abs/1607.06450>paper</a>.</p><figure><img src=https://www.fromkk.com/images/transformer_layer_norm.png width=500></figure><h3 id=position-wise-feed-forward-network>Position-wise Feed Forward Network</h3><p>This layer is a Neural Network whose size is <code>(512, 2048, 512)</code>. The exact same feed-forward network is independently applied to each position.</p><figure><img src=https://www.fromkk.com/images/transformer_encoder.png width=500></figure><h2 id=output-input>Output Input</h2><p>Same as Input.</p><h2 id=decoder>Decoder</h2><p>The decoder is pretty similar to Encoder. It also has 6 layers, but has 3 sublayers in each Decoder. It add a masked multi-head-attention at the beginning of Decoder.</p><h3 id=masked-multi-head-attention>Masked Multi-Head Attention</h3><p>This layer is used to block future words during training. For example, if the output is <code>&lt;bos> hello world &lt;eos></code>. First, we should use <code>&lt;bos></code> as input to predict <code>hello</code>, <code>hello world &lt;eos></code> will be masked to 0.</p><h3 id=key-and-value-in-decoder-multi-head-attention-layer>Key and Value in Decoder Multi-Head Attention Layer</h3><p>In Encoder, the <code>q</code> <code>k</code> <code>v</code> vector is generated by \(XW^Q\), \(XW^K\) and \(XW^V\). In the second sub-layer of Decoder, <code>q</code> <code>k</code> <code>v</code> was generated by \(XW^Q\), \(YW^K\) and \(YW^V\), where \(Y\) is the Encoder&rsquo;s output, \(X\) is the <code>&lt;init of sentence></code> or previous output.</p><p>The animation below illustrates how to apply the Transformer to machine translation.</p><figure><img src=https://www.fromkk.com/images/transformer_translate.gif width=500></figure><h2 id=output>Output</h2><p>Using a linear layer to predict the output.</p><h2 id=ref>Ref:</h2><ol><li><a href=http://nlp.seas.harvard.edu/2018/04/03/attention.html>The Annotated Transformer</a></li><li><a href=http://jalammar.github.io/illustrated-transformer/>The Illustrated Transformer</a></li><li><a href=https://mchromiak.github.io/articles/2017/Sep/12/Transformer-Attention-is-all-you-need/#.XMb3ZC97FPs>The Transformer – Attention is all you need</a></li><li><a href=https://medium.com/@bgg/seq2seq-pay-attention-to-self-attention-part-2-cf81bf32c73d>Seq2seq pay Attention to Self Attention: Part 2</a></li><li><a href=https://juejin.im/post/5b9f1af0e51d450e425eb32d>Transformer模型的PyTorch实现</a></li><li><a href=https://towardsdatascience.com/how-to-code-the-transformer-in-pytorch-24db27c8f9ec>How to code The Transformer in Pytorch</a></li><li><a href=https://towardsdatascience.com/deconstructing-bert-part-2-visualizing-the-inner-workings-of-attention-60a16d86b5c1>Deconstructing BERT, Part 2: Visualizing the Inner Workings of Attention</a></li><li><a href=https://ai.googleblog.com/2017/08/transformer-novel-neural-network.html>Transformer: A Novel Neural Network Architecture for Language Understanding</a></li><li><a href=https://d2l.ai/chapter%5Fattention-mechanisms/transformer.html>Dive into Deep Learning - 10.3 Transformer</a></li></ol></div><footer><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"kkblog-1"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js id=MathJax-script></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};</script></section></div><footer class=footer><section class=container>©
2020
KK
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-153788833-1','auto');ga('send','pageview');}</script></body></html>